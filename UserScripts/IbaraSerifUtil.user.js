// ==UserScript==
// @name        IbaraSerifUtil
// @namespace   https://twitter.com/11powder
// @description セリフをどんどん入れよう！
// @include     http://lisge.com/ib/*.php*
// @version     1.0.3.2
// @updateURL   https://pejuta.github.io/IbaraUtilities/UserScripts/IbaraSerifUtil.user.js
// @downloadURL https://pejuta.github.io/IbaraUtilities/UserScripts/IbaraSerifUtil.user.js
// @grant       none
// ==/UserScript==
!function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=19)}([function(e,t,n){"use strict";e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n=function(e,t){var n=e[1]||"",i=e[3];if(!i)return n;if(t&&"function"==typeof btoa){var r=(o=i,"/*# sourceMappingURL=data:application/json;charset=utf-8;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(o))))+" */"),s=i.sources.map((function(e){return"/*# sourceURL="+i.sourceRoot+e+" */"}));return[n].concat(s).concat([r]).join("\n")}var o;return[n].join("\n")}(t,e);return t[2]?"@media "+t[2]+"{"+n+"}":n})).join("")},t.i=function(e,n){"string"==typeof e&&(e=[[null,e,""]]);for(var i={},r=0;r<this.length;r++){var s=this[r][0];null!=s&&(i[s]=!0)}for(r=0;r<e.length;r++){var o=e[r];null!=o[0]&&i[o[0]]||(n&&!o[2]?o[2]=n:n&&(o[2]="("+o[2]+") and ("+n+")"),t.push(o))}},t}},function(e,t,n){var i,r,s={},o=(i=function(){return window&&document&&document.all&&!window.atob},function(){return void 0===r&&(r=i.apply(this,arguments)),r}),a=function(e,t){return t?t.querySelector(e):document.querySelector(e)},l=function(e){var t={};return function(e,n){if("function"==typeof e)return e();if(void 0===t[e]){var i=a.call(this,e,n);if(window.HTMLIFrameElement&&i instanceof window.HTMLIFrameElement)try{i=i.contentDocument.head}catch(e){i=null}t[e]=i}return t[e]}}(),c=null,h=0,u=[],d=n(12);function p(e,t){for(var n=0;n<e.length;n++){var i=e[n],r=s[i.id];if(r){r.refs++;for(var o=0;o<r.parts.length;o++)r.parts[o](i.parts[o]);for(;o<i.parts.length;o++)r.parts.push(w(i.parts[o],t))}else{var a=[];for(o=0;o<i.parts.length;o++)a.push(w(i.parts[o],t));s[i.id]={id:i.id,refs:1,parts:a}}}}function b(e,t){for(var n=[],i={},r=0;r<e.length;r++){var s=e[r],o=t.base?s[0]+t.base:s[0],a={css:s[1],media:s[2],sourceMap:s[3]};i[o]?i[o].parts.push(a):n.push(i[o]={id:o,parts:[a]})}return n}function f(e,t){var n=l(e.insertInto);if(!n)throw new Error("Couldn't find a style target. This probably means that the value for the 'insertInto' parameter is invalid.");var i=u[u.length-1];if("top"===e.insertAt)i?i.nextSibling?n.insertBefore(t,i.nextSibling):n.appendChild(t):n.insertBefore(t,n.firstChild),u.push(t);else if("bottom"===e.insertAt)n.appendChild(t);else{if("object"!=typeof e.insertAt||!e.insertAt.before)throw new Error("[Style Loader]\n\n Invalid value for parameter 'insertAt' ('options.insertAt') found.\n Must be 'top', 'bottom', or Object.\n (https://github.com/webpack-contrib/style-loader#insertat)\n");var r=l(e.insertAt.before,n);n.insertBefore(t,r)}}function g(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e);var t=u.indexOf(e);t>=0&&u.splice(t,1)}function m(e){var t=document.createElement("style");if(void 0===e.attrs.type&&(e.attrs.type="text/css"),void 0===e.attrs.nonce){var i=function(){0;return n.nc}();i&&(e.attrs.nonce=i)}return v(t,e.attrs),f(e,t),t}function v(e,t){Object.keys(t).forEach((function(n){e.setAttribute(n,t[n])}))}function w(e,t){var n,i,r,s;if(t.transform&&e.css){if(!(s="function"==typeof t.transform?t.transform(e.css):t.transform.default(e.css)))return function(){};e.css=s}if(t.singleton){var o=h++;n=c||(c=m(t)),i=E.bind(null,n,o,!1),r=E.bind(null,n,o,!0)}else e.sourceMap&&"function"==typeof URL&&"function"==typeof URL.createObjectURL&&"function"==typeof URL.revokeObjectURL&&"function"==typeof Blob&&"function"==typeof btoa?(n=function(e){var t=document.createElement("link");return void 0===e.attrs.type&&(e.attrs.type="text/css"),e.attrs.rel="stylesheet",v(t,e.attrs),f(e,t),t}(t),i=x.bind(null,n,t),r=function(){g(n),n.href&&URL.revokeObjectURL(n.href)}):(n=m(t),i=y.bind(null,n),r=function(){g(n)});return i(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap)return;i(e=t)}else r()}}e.exports=function(e,t){if("undefined"!=typeof DEBUG&&DEBUG&&"object"!=typeof document)throw new Error("The style-loader cannot be used in a non-browser environment");(t=t||{}).attrs="object"==typeof t.attrs?t.attrs:{},t.singleton||"boolean"==typeof t.singleton||(t.singleton=o()),t.insertInto||(t.insertInto="head"),t.insertAt||(t.insertAt="bottom");var n=b(e,t);return p(n,t),function(e){for(var i=[],r=0;r<n.length;r++){var o=n[r];(a=s[o.id]).refs--,i.push(a)}e&&p(b(e,t),t);for(r=0;r<i.length;r++){var a;if(0===(a=i[r]).refs){for(var l=0;l<a.parts.length;l++)a.parts[l]();delete s[a.id]}}}};var T,S=(T=[],function(e,t){return T[e]=t,T.filter(Boolean).join("\n")});function E(e,t,n,i){var r=n?"":i.css;if(e.styleSheet)e.styleSheet.cssText=S(t,r);else{var s=document.createTextNode(r),o=e.childNodes;o[t]&&e.removeChild(o[t]),o.length?e.insertBefore(s,o[t]):e.appendChild(s)}}function y(e,t){var n=t.css,i=t.media;if(i&&e.setAttribute("media",i),e.styleSheet)e.styleSheet.cssText=n;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(n))}}function x(e,t,n){var i=n.css,r=n.sourceMap,s=void 0===t.convertToAbsoluteUrls&&r;(t.convertToAbsoluteUrls||s)&&(i=d(i)),r&&(i+="\n/*# sourceMappingURL=data:application/json;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(r))))+" */");var o=new Blob([i],{type:"text/css"}),a=e.href;e.href=URL.createObjectURL(o),a&&URL.revokeObjectURL(a)}},function(e,t){e.exports='　<span class="B2">－　－　－　－　－　－　O R　－　－　－　－　－　－</span><br>\r\n'},function(e,t){e.exports="<div class='Preview'><div class='Y3 PreviewHeader'>《{PREVIEW_TYPE}プレビュー》 <a href='#'> [Help] </a></div><span class=\"PreviewBody\"></span></div>"},function(e,t){e.exports='<div class="SE1"><table class="BLK0"><tr valign="TOP">\r\n   <td width="60"><img src=\'{ICON_URL}\' class=\'IC\'></td>\r\n   <td style="color:#CC8844">{SERIF_HTML}</td>\r\n</tr></table></div><div class="CL"></div>'},function(e,t){e.exports="<div class='SE2'>【ERROR】書き込み内容は{MAX_CHARS}文字以内です！（現在{CHARS}文字）</div>"},function(e,t){e.exports="<div style='position: absolute; z-index: 2;'><div class='SE3'><table cellpadding='0' cellspacing='0' class='SE0'><tr valign='TOP'>\r\n    <td width='70'><img src='p/iba_icon.png' class='RE2' alt='RE'></td>\r\n    <td class='F3'>\r\n        <a><span class='Y4'>{SCRIPT_NAME}の機能・使い方</span></a><br>\r\n            <div style='margin:10px;'>\r\n            ・入力した発言内容を自動的に解析してプレビューを表示します。<br>\r\n            ・入力欄の上あたりにタグ入力補助バーを表示します。<br>\r\n            ・<b class='O3'>Ctrl+Shift+Enterキー</b>を押すと発言内容を送信します。<br>\r\n            ・<b class='O3'>Tab</b>キーを押すと、閉じタグ(<b class='Y3'>&lt;/B&gt;, &lt;/f4&gt;</b>など)を自動的に補完します。<br>\r\n            ・タグ名(<b class='Y3'>i4, S</b>など)を入力してからTabキーを押すと、指定の装飾タグを自動入力します。<br>\r\n            　<span class='P3'>例： f5 ⇒ &lt;f5&gt&lt;/f5&gt</span><br>\r\n            <br>　(hint) 入力自動補完に対応しているタグ名の一覧（小文字可、半角のみ）：<br><b class='Y3'>\r\n                　　 F[1-7] B B[1-7] I I[1-7] S S[1-7] U U[1-7]\r\n            </b>\r\n            </div>\r\n    </td>\r\n</tr></table></div></div>"},function(e,t){e.exports='<div class="TagHelper">\r\n<span class="TagF"> F </span><span class="TagB"> B </span><span class="TagI"> I </span><span class="TagS"> S </span><span class="TagU"> U </span><span class="TagDice">1</span><span class="TagBR">BR</span>\r\n</div>'},function(e,t){e.exports='<div id="IbaraTalkUtilSettings" class="UtilSettings F3"><b class="Y4">IbaraSerifUtil 機能設定</b>\r\n<div class="SettingsBody"><input type="checkbox" id="EnablePreview">セリフプレビューを表示する。\r\n<input type="checkbox" id="EnableInputToTextarea">テキスト入力ボックスで複数行の入力を可能にする。\r\n<input type="checkbox" id="EnableTagHelper">装飾タグ簡単入力用ツールバーを表示する。\r\n<input type="checkbox" id="EnableTagCompletion">装飾タグの自動入力・入力支援を利用する。\r\n<input type="checkbox" id="EnableEZFormSub">Ctrl+Shift+Enter押下で発言を送信する。\r\n<input type="checkbox" id="EnableBRConverter">BRタグの置換/自動挿入機能を利用する。\r\n<input type="checkbox" id="EnableMultipleSubDenier">多重送信を防止する。\r\n<input type="checkbox" id="EnableIconIndexer">アイコンに番号を振る。\r\n<span class="P2">※ 設定はリロード後に有効になります。</span></div>\r\n<span class="SaveSettings SettingsButton BUTT3">保存して閉じる</span><span class="CancelSetting SettingsButton BUTT1">キャンセル</span></div>'},function(e,t){e.exports='<div id="SerifUtilSettings" class="SLINKBG"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAJYAAAAyCAYAAAC+jCIaAAAFbklEQVR4Xu2dTWgbRxiG39mVtNKuJCuOHAIB0+ZmCDS3kosBt6XQS3vxqUBNgRICpReDgZ4LFNJLgP5BoTkVCO0tQKmTQi+lx4IhPfnSlAKWE+OVZK1W3ungDBrYXWW0P7ZW6vfAy8zOyGt5vndmdobdNeOcI28IogQBQTxmzARQFqrINDYfOVbpsw3Of52xsYhHjBlME0BNXpeqvJIlVBWyhRpCS0LLQiuyPAvfCv3/jPULY8zUBEwfQJnXB1RJBbIu1JSBbLMXxwyLQ/1CpsJdJgBKCXpl+t6o8paULeTIQF4SumyKNL9AEoHUqTy2gEtRY6l5dgnAu6Fg6XplVcqRw2tLqG0Ay1HjElwGIxinKq/KQ3Uq1ecn16tjjXwleEInUl0pV2gExYdC7wNXJxoLLyrvo4joGy8aiPjP6IOQMjCjUEAGMiA9yIDIco7FwsQZr77MWDUI+kL/6gMRDUzqgKigDFVA0BfqKhU0IISBM1qPGCu/wbk/0Vh/C91BIggyFtgL//iyLGoshukhCCPkn1yMRRBmjLFKeRjrOmNYQVo4/uCYO9YYQxNRDjjHfky7DMDxJ0/TnsVvH0NvLNhpTrtdv4x1C+noH+FG38d8wLBlOfjYqcEyEIOH354d404QbRfXPcQtL0janvHtY1bwoGKO18o/nQzxAxKgOU8GY9kpRixiveJgu1HDzGElrDmOPOjh2slwpucxpp0KDWTg1IcXYHo4RzEw8LnTxJuyRTonx3h7GEBh4oOaMpU76OLpKUJw7HMUB6OCnxs22hBghF23i51gNtdYNjLi9o/lkD9/NIwyrDLOaA6ixmuWMebp4ASbIxQchma5DAsCBGhc4MW7EWcshukhCEbXWC8jwN1uB/e7ahU39wRD3D7soDpesc5ku4FGrH25VbAwyC2O7GRfFdYxcwx82Ui6fRFdzm/bK9iyocc7xo7r4eH494bOZ1j4fbkZuT5Za61gb/J2w/lQsrHXckKFDrbaQlA8OTrA5gjqu4e+2yx23peSjlgEYepHLFzJbCzG8LqQltCO9GJDF++rWY3VqC/ju3qqKUxfr58y89/dDzzc6hwAKONBu4W10HRzoYz6uNHph6bEHr4XZXcLNmIZoac0rtJUSOR98V4TYmmM5QY+PB9TY5llwMDiQcZqTjIWkhsrwE7vKM2qb/EgYy3HG6uANIQJ9xqYD8hY11RZ1hFLQZCxXtlljJGxiLxXhVUDsDTXWIVAbTcUHxqxlI8GuY9YBBnrgqZCgoyVAoIwL2DEImjEssNldmJjEUTUL7WcVoUMrzGgmuDzFsMCo7/rI3v7cHgALBQDU2MsO+2TIF/Lm8nyIcBfoxHWrVJo532On09Ud33kw+kI/wTAdSP+Rj9186JAQavCe4MunowwCYL7+KY7KPI1VvyIZSAJHMe+jwrScczjG27z6BCfVm28ZZXQSPF84pD78HxVl/Qujej34hj6oh7y/AnOl57J3/3h0EXnuYePqhZulkKTUcDhRWITwI2bUn1f/X05jljj13E/ZuwrALchcIXew3QQxI9CLYz5ZIPzewYUznlMhQTtY7XSGIsgmGYf68p5GIugDdJVpIAgzAmrQvUghcQS+mLSS2ozvXk4+jJbT2gY8zLbnjzX3EEjljM2lnqQQjnwZoFeUh81tb5O/zOqTJ9GFUx4DfdQyFMdBb3wW58X31hLIWMVD0OqhAVAY16pqOH15fH12s4TryCmowxC/0TAlZ2GxxurPTaW7FjvCDEVz+x5TZ2mXnOslxlKS0KmVEkJZZlWIFMpK5Q3hVj2jrIYcGXucKOsqg1SYtr/DSQUMThDyrI8P5u6PP+Bgm1w/tm5GIsg/gNv73XiyOGgDgAAAABJRU5ErkJggg==" class="SLINK"></div>'},function(e,t,n){var i=n(11);"string"==typeof i&&(i=[[e.i,i,""]]);var r={hmr:!0,transform:void 0,insertInto:void 0};n(1)(i,r);i.locals&&(e.exports=i.locals)},function(e,t,n){(e.exports=n(0)(!1)).push([e.i,'@charset "utf-8";\r\n\r\n.SE1 {\r\n    max-width: 850px;\r\n}\r\n',""])},function(e,t){e.exports=function(e){var t="undefined"!=typeof window&&window.location;if(!t)throw new Error("fixUrls requires window.location");if(!e||"string"!=typeof e)return e;var n=t.protocol+"//"+t.host,i=n+t.pathname.replace(/\/[^\/]*$/,"/");return e.replace(/url\s*\(((?:[^)(]|\((?:[^)(]+|\([^)(]*\))*\))*)\)/gi,(function(e,t){var r,s=t.trim().replace(/^"(.*)"$/,(function(e,t){return t})).replace(/^'(.*)'$/,(function(e,t){return t}));return/^(#|data:|http:\/\/|https:\/\/|file:\/\/\/|\s*$)/i.test(s)?e:(r=0===s.indexOf("//")?s:0===s.indexOf("/")?n+s:i+s.replace(/^\.\//,""),"url("+JSON.stringify(r)+")")}))}},function(e,t,n){var i=n(14);"string"==typeof i&&(i=[[e.i,i,""]]);var r={hmr:!0,transform:void 0,insertInto:void 0};n(1)(i,r);i.locals&&(e.exports=i.locals)},function(e,t,n){(e.exports=n(0)(!1)).push([e.i,'@charset "utf-8";\r\n\r\n#PreviewFooter {\r\n    margin-bottom: 15px;\r\n    max-width: 870px;\r\n    max-height: 50vh;\r\n}\r\n\r\n#FooterToggle {\r\n    height: 20px;\r\n    font-size: 14px;\r\n    font-weight: bold;\r\n    text-align: left;\r\n}\r\n\r\n#FooterBody {\r\n    overflow-y: scroll;\r\n    max-height: calc(50vh - 20px);\r\n}',""])},function(e,t,n){var i=n(16);"string"==typeof i&&(i=[[e.i,i,""]]);var r={hmr:!0,transform:void 0,insertInto:void 0};n(1)(i,r);i.locals&&(e.exports=i.locals)},function(e,t,n){(e.exports=n(0)(!1)).push([e.i,'@charset "utf-8";\r\n\r\n.TagHelper {\r\n    position: absolute;\r\n    width: 280px;\r\n    height: 20px;\r\n    z-index: 100;\r\n    display: none;\r\n}\r\n.TagHelper > span {\r\n    background: radial-gradient(rgba(0,0,0,0.9),rgba(0,0,0,0.9));\r\n    display: inline-block;\r\n    width: 40px;\r\n    height: 100%;\r\n    text-align: center;\r\n    line-height: 1em;\r\n    font-size: 20px;\r\n    white-space: pre;\r\n}\r\n.TagHelper > span:hover {\r\n    background: radial-gradient(rgba(95,0,0,0.9),rgba(0,0,0,0.9));\r\n}\r\n.TagF {\r\n    position: relative;\r\n}\r\n.TagF:after {\r\n    content:"F";\r\n    font-size: 11px;\r\n    line-height: 11px;\r\n    position: absolute;\r\n    left: 22px;\r\n    top: 7px;\r\n}\r\n.TagB {\r\n    font-weight: bold;\r\n}\r\n.TagI {\r\n    font-style: italic;\r\n}\r\n.TagS {\r\n    text-decoration: line-through;\r\n}\r\n.TagU {\r\n    text-decoration: underline;\r\n}\r\n.TagDice {\r\n    font-family: "dice", sans-serif;\r\n}\r\n',""])},function(e,t,n){var i=n(18);"string"==typeof i&&(i=[[e.i,i,""]]);var r={hmr:!0,transform:void 0,insertInto:void 0};n(1)(i,r);i.locals&&(e.exports=i.locals)},function(e,t,n){(e.exports=n(0)(!1)).push([e.i,"#SerifUtilSettings {\r\n    cursor: pointer;\r\n    background-image: url('data:image/png;base64,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');\r\n}\r\n\r\n.UtilSettings {\r\n    position: fixed;\r\n    z-index: 999;\r\n    margin: auto;\r\n    top: 0;\r\n    right: 0;\r\n    bottom: 0;\r\n    left: 0;\r\n    width: 420px;\r\n    height: 200px;\r\n    background-color: rgba(0,0,0,0.95);\r\n    padding: 20px;\r\n    border-radius: 10px;\r\n}\r\n\r\n.SettingsBody {\r\n    margin: 4px;\r\n    white-space: pre-wrap;\r\n}\r\n.SettingsBody > input {\r\n    margin-right: 10px;\r\n}\r\n.SettingsButton  {\r\n    margin: 0 4px;\r\n    padding: 2px 20px;\r\n}",""])},function(e,t,n){"use strict";function i(e,t){let n=e.toString();for(const e in t)void 0!==t[e]&&null!==t[e]&&(n=n.replace(new RegExp("{"+e+"}","g"),t[e].toString()));return n}n.r(t);const r={"&":"&amp;","'":"&#x27;",'"':"&quot;","`":"&#x60;","<":"&lt;",">":"&gt;"},s=new RegExp(`[${Object.keys(r).join("")}]`,"g");function o(e){return e.replace(s,e=>r[e])}const a=/(?:\r\n|\r|\n)/g,l=/<br>/gi;function c(e){return e?e.replace(a,"<br>"):e}function h(e){return e?e.replace(l,"\n"):e}const u=function e(t){const n=Object.getOwnPropertyNames(t);for(const i of n){const n=t[i];t[i]=n&&"object"==typeof n?e(n):n}return Object.freeze(t)}({F:{pattern:"F(?=\\d)",tagName:"span"},B:{pattern:"B",tagName:"b"},I:{pattern:"I",tagName:"i"},S:{pattern:"S",tagName:"s"},U:{pattern:"U",tagName:"u"}});let d=0;const p=[];for(const e in u)if(u.hasOwnProperty(e)){const t=u[e].pattern;d=t.length,p.push(t)}const b=d+1,f=p.join("|"),g="(?:"+f+")[1-7]?";function m(e,t,n,i){const r=u[t.toUpperCase()].tagName;return n?`<${r} class='F${n}'>${i}</${r}>`:`<${r}>${i}</${r}>`}const v=new RegExp(o("<"+("("+f+")([1-7]?)")+">(.*?)</\\1\\2>"),"ig");class w{constructor(){this.id=0,this.prevResolve=null}setDelay(e,t,...n){return new Promise((i,r)=>{this.id&&this.prevResolve&&(clearTimeout(this.id),this.prevResolve(null)),this.id=setTimeout(t=>{this.id=0,this.prevResolve=null,i(e.apply(null,t))},t,n),this.prevResolve=i})}static delay(e){return new Promise(t=>{setTimeout(()=>t(),e)})}}var T=n(3),S=n.n(T);class E{constructor(e){this.$preview=null,this.delayMS=e.delayMS,this.previewType=e.previewType,this.containerClass=e.containerClass,this.removePreviousPreview=e.removePreviousPreview,this.delayer=new w}buildDelayedEventCallback(e){const t=this.buildInstantEventCallback(e);return e=>{this.delayer.setDelay(()=>{t(e)},this.delayMS)}}buildInstantEventCallback(e){return t=>{this.insertPreview(e.targetSelector(t),e.type);const n=this.buildHtml(t);this.updatePreview(n)}}insertPreview(e,t){switch(t){case"insertBefore":this.$preview&&$(e).prev().is("."+E.PREVIEW_CONTAINER_CLASS_NAME)?this.$preview=$(e).prev():(this.$preview&&this.removePreviousPreview||(this.$preview=this.buildContainer()),this.$preview.insertBefore(e));break;case"insertAfter":this.$preview&&$(e).next().is("."+E.PREVIEW_CONTAINER_CLASS_NAME)?this.$preview=$(e).next():(this.$preview&&this.removePreviousPreview||(this.$preview=this.buildContainer()),this.$preview.insertAfter(e));break;case"prepend":this.$preview&&$(e).children().first().is("."+E.PREVIEW_CONTAINER_CLASS_NAME)?this.$preview=$(e).children().first():(this.$preview&&this.removePreviousPreview||(this.$preview=this.buildContainer()),this.$preview.prependTo(e));break;case"append":this.$preview&&$(e).children().last().is("."+E.PREVIEW_CONTAINER_CLASS_NAME)?this.$preview=$(e).children().last():(this.$preview&&this.removePreviousPreview||(this.$preview=this.buildContainer()),this.$preview.appendTo(e))}return this.$preview}updatePreview(e){this.$preview||this.throwNoPreviewContainerError(),this.$preview.find(".PreviewBody").html(e),e?this.$preview.show():this.$preview.hide()}showPreview(){this.$preview||this.throwNoPreviewContainerError(),this.$preview.show()}hidePreview(){this.$preview||this.throwNoPreviewContainerError(),this.$preview.hide()}buildContainer(){return this.$preview=$(`<div class="${E.PREVIEW_CONTAINER_CLASS_NAME}"/>`).html(i(S.a,{PREVIEW_TYPE:this.previewType})).addClass(this.containerClass),this.$preview}throwNoPreviewContainerError(){throw new Error("invalid operation: preview container have not inserted yet.")}}E.PREVIEW_CONTAINER_CLASS_NAME="PreviewContainer";const y=/^[ \r\n\t\v]+/,x=/[ 　]+$/;const I=/[\u{0}-\u{9}\u{B}\u{C}\u{E}-\u{1F}\u{10000}-\u{10FFFF}]/gu;class A extends E{constructor(e){super(e),this.userENo=(/IBR_KEY=.+?_(\d+)(?:;|$)/.exec(document.cookie)||[])[1]||null}static sanitizeText(e){return function(e,t=""){return e.replace(I,t)}(function(e,t=""){return e?(e=(e=e.replace(y,"")).replace(x,""))||t:e}(e,"?"),"?")}}A.DEFAULT_ICON="p/nii.png";var C="IbaraSerifUtil",N=200,k=4;class P{static extract(e=""){const t=$(`input[name^=dt_icai${e}]`).get().map(e=>e.value);localStorage.setItem(P.STORAGE_NAME+e,JSON.stringify(t))}static load(e=""){const t=localStorage.getItem(P.STORAGE_NAME+e);return t?JSON.parse(t):[]}}P.STORAGE_NAME=C+"_IconNicknames";var B=n(4),R=n.n(B),D=n(2),F=n.n(D),L=n(5),M=n.n(L);n(10);const j=/^\/((?:\+|-)?\d+)\//;class U extends A{constructor(e,t=!1,n={}){var i,r,s,o;super({delayMS:e,previewType:"セリフ",containerClass:"SerifPreview",removePreviousPreview:t}),this.delayMS=e,this.maxChars=U.DEFAULT_MAX_CHARS,this.iconUrls=null!=(i=n.iconUrls)?i:$("#ICONLIST img.IC").get().map(e=>{var t;return null!=(t=e.getAttribute("src"))?t:""}),this.iconNicknames=null!=(r=n.iconNicknames)?r:$("#ICONLIST img.IC").get().map(e=>{var t;return null!=(t=e.getAttribute("alt"))?t:""}),this.subIconNicknames=null!=(s=n.subIconNicknames)?s:P.load(),this.nickname=null!=(o=n.nickname)?o:$(".SHIDARI > table:first a.F2:first > b + br")[0].nextSibling.textContent}enableSerifPreview(e,t,n=(e=>e.nextElementSibling),i=(e=>e.previousElementSibling),r=!1){const s=this.buildDelayedEventCallback({targetSelector:e=>n(e.currentTarget),type:"insertAfter"}),o=this.buildDelayedEventCallback({targetSelector:e=>e.currentTarget,type:"insertAfter"}),a=(this.buildDelayedEventCallback({targetSelector:e=>e.currentTarget,type:"insertAfter"}),["icon",n]),l=["text",i];if(e.on({change:s},a),t.on({"focus input":o},l),r){const e=this.buildInstantEventCallback({targetSelector:e=>e.currentTarget,type:"insertAfter"}),n="TEMP_INSTANT",i={};i[n]=e,t.on(i,l).trigger(n).off(n)}return this}buildHtml(e){e.data[0];const t=e.data[1];let n,i;"icon"===e.data[0]?(i=$(e.currentTarget),n=$(t(e.currentTarget))):(n=$(e.currentTarget),i=$(t(e.currentTarget)));const r={$icon:i,$text:n};return this.formatPreviewHtml(r)}formatPreviewHtml(e){const t=A.sanitizeText(e.$text.val());return 0===t.length?t:t.length>this.maxChars?i(M.a,{CHARS:t.length,MAX_CHARS:this.maxChars}):this.formatSerifHtml(t,e)}formatSerifHtml(e,t){const n=t.$icon.val();let i=-1;/^\d+$/.test(n)&&(i=parseInt(n,10));const r=t.$name?t.$name.val():this.nickname,s=e.split("###"),o=[];let a=0,l=null;for(const e of s){const t=e.split("+++");if(""===t.join("")){a++;continue}const n=[];for(const e of t){const t=this.formatSingleBlockedSerifHtml(e,i,l,r);n.push(t.serif),l=t.nickname}o.push(n.join(""))}return a>0&&o.push(`<div class='NoSerif'>セリフなし(${(a/s.length*100).toFixed(0)}%)</div>`),o.join(F.a)}formatSingleBlockedSerifHtml(e,t,n,r){if(!e)return{nickname:n,serif:e};let s=n;null===s&&(s=this.subIconNicknames[t]||this.iconNicknames[t]||r);let a=t;const l=j.exec(e);l&&(a=parseInt(l[1],10),e=e.substring(l[0].length),s=this.subIconNicknames[a]||this.iconNicknames[a]||r);const h=a in this.iconUrls?this.iconUrls[a]:A.DEFAULT_ICON,u=/^@([^@]*?)@/.exec(e);return u&&(s=u[1],e=e.substring(u[0].length)),e=function(e){let t=o(e);t=c(t).replace(/&lt;br&gt;/gi,"<BR>");for(let e=0;e<2;e++)t=t.replace(/&lt;(([1-9][0-9]?)D([1-9][0-9]?[0-9]?))&gt;/i,"<span class='DX'>【 <b>$1</b>：[$2個の$3面ダイスを振る] 】</span>");return function(e,t,n){let i=e.toString();for(;;){if(!t.test(i))return i;i=i.replace(t,n)}}(t,v,m)}(e),s&&(e=`${o(s)}<br>「${e}」`),{nickname:s,serif:i(R.a,{ICON_URL:h,SERIF_HTML:e})}}}function O(e,t,n){let i,r=void 0;n?(i=n,r=t):i=t;const s=function(e,...t){return"touchstart"===e.type&&e.preventDefault(),i.apply(this,[e,...t])};return e.on({click:s,ontouchstart:s},r)}U.DATANAME_INITIAL_PREVIEW_HIDDEN="initial_preview_hidden",U.DEFAULT_MAX_CHARS=400;n(13);class H extends U{constructor(e){super(e,!0),this.$footer=null}enableMessagePreview(e,t,n,i,r=!1){this.$footer=$("<div id='PreviewFooter'><div id='FooterToggle'>▲▼ プレビュー表示切り替え</div><div id='FooterBody'></div></div>").prependTo(i),O(this.$footer.find("#FooterToggle"),(function(){const e=$(this).next();if("0px"===e.css("height")){const t=e.css("height","auto").height();e.css("height","0px").animate({height:t},200,()=>e.css("height","auto"))}else e.css("height",e.height()).animate({height:"0px"},200)}));const s=this.buildDelayedEventCallback({targetSelector:e=>this.$footer.find("#FooterBody")[0],type:"append"}),o={$icon:e,$text:t,$name:n};if(e.on({change:s},o),t.on({"input focus":s},o),n.on({"input focus":s},o),r){const e=this.buildInstantEventCallback({targetSelector:e=>this.$footer[0],type:"append"}),n="TEMP_INSTANT",i={};i[n]=e,t.on(i,o).trigger(n).off(n)}return this}buildHtml(e){return this.formatPreviewHtml(e.data)}}var _=n(6),Y=n.n(_);class z{constructor(e){this.attachedElement=null,this.$help=$(i(Y.a,{SCRIPT_NAME:e}));const t=this;this.onClickHandler=function(e){e.preventDefault();const n=this;t.attachedElement===n?(t.$help.hide(),t.attachedElement=null):(t.$help.insertAfter(n).show(),t.attachedElement=n)}}enable(e,t){t?O($(e),t,this.onClickHandler):O($(e),this.onClickHandler),O(this.$help,()=>{this.$help.hide(),this.attachedElement=null})}}class K{constructor(){}enable(e,t,n){let i="input[type='submit']";"string"==typeof n&&(i+="[value='"+n+"']");const r=this,s=function(e){const t=$(this).closest("form").find(i);r.submitWithCertainKeysDown(t,e)};return t?$(e).on("keydown",t,s):$(e).on("keydown",s),this}submitWithCertainKeysDown(e,t){13===t.keyCode&&t.ctrlKey&&t.shiftKey&&(t.preventDefault(),e.first().trigger("click"))}}const G=-1!==navigator.userAgent.toLowerCase().indexOf("firefox");function W(e,t,n,i){e.focus(),G?(e.setRangeText(t,n,i,"end"),$(e).trigger("input")):(e.setSelectionRange(n,i),document.execCommand("insertText",!1,t))}const Q=new RegExp("<("+g+")>","gi"),V=new RegExp("</("+g+")>","gi"),X=new RegExp("<?("+g+")>?$","i"),Z=new RegExp("</("+g+")>$","i"),J=new RegExp("</?([^>]{0,"+b+"}?)$"),q=new RegExp(g,"i");class ee{constructor(){}enable(e,t){const n=this,i=function(e){n.autoCompleteTag(this,e)};return t?$(e).on("keydown",t,i):$(e).on("keydown",i),this}autoCompleteTag(e,t){if(9===t.keyCode){if(t.preventDefault(),e.selectionEnd&&e.selectionStart!==e.selectionEnd)return void e.setSelectionRange(e.selectionEnd,e.selectionEnd);if(this.insertOrnamentTags(e))return;this.insertLastUnclosedTagEnd(e)}else"/"===t.key&&this.completeLastUnclosedTagEnd(e)&&t.preventDefault()}insertOrnamentTags(e){if("number"!=typeof e.selectionStart)return!1;if(e.selectionEnd&&e.selectionStart!==e.selectionEnd)return!1;const t=e.selectionStart,n=e.value.slice(0,t),i=e.value.slice(t),r=X.exec(n);if(!r)return!1;if(Z.test(n))return!1;if(/^<[^<>]+?>$/.test(r[0]))return!1;const s=J.exec(n);if(s){const e=new RegExp("^([^<]{0,"+(b-s[1].length)+"}?)>").exec(i);if(e){if(q.test(s[1]+e[1]))return!1}}W(e,"<"+r[1]+"></"+r[1]+">",t-r[0].length,t);const o=t-r[0].length+r[1].length+2;return e.setSelectionRange(o,o),!0}insertLastUnclosedTagEnd(e){if("number"!=typeof e.selectionStart)return!1;if(e.selectionEnd&&e.selectionStart!==e.selectionEnd)return!1;const t=e.selectionStart,n=e.value.slice(0,t),i=e.value.slice(t),r=this.findUnclosedTags(n,i);return 0!==r.length&&(W(e,"</"+r[r.length-1]+">",t,t),!0)}findUnclosedTags(e,t){const n=e.match(Q);if(!n)return[];const i=n.map((e,t)=>e.slice(1,e.length-1)),r=(e+t).match(V);if(!r)return i;const s=r.map((e,t)=>e.slice(2,e.length-1));for(let e=s.length-1;e>=0;e--)for(let t=i.length-1;t>=0;t--)if(s[e]===i[t]){i.splice(t,1);break}return i}completeLastUnclosedTagEnd(e){if("number"!=typeof e.selectionStart)return!1;if(e.selectionStart<=0||e.selectionStart!==e.selectionEnd)return!1;const t=e.selectionStart,n=e.value.slice(0,t),i=e.value.slice(t);if("<"!==n[t-1])return!1;const r=this.findUnclosedTags(n,i);return 0!==r.length&&(W(e,"/"+r[r.length-1]+">",t,t),!0)}}const te=new RegExp("^[ \\r\\n\\t\\v]*<br>","i");function ne(e){if(!e)return h(e);const t=te.exec(e);return t?t[0]+h(e.substring(t[0].length)):h(e)}function ie(e){if(!e)return c(e);const t=y.exec(e);return t?t[0]+c(e.substring(t[0].length)):c(e)}const re=new RegExp("^[ \\r\\n\\t\\v]*?((?:\\r\\n|\\r|\\n))$");class se{constructor(e=!0){this.convertsOnEnable=e}enable(e,t,n={}){const i=e=>{!1!==n.insertsLeadingBRs&&se.insertBRTagIfLeadingSpaces(e)};if(t?$(e).on("input",t,i):$(e).on("input",i),this.convertsOnEnable){if(!1===n.convertsBRTagsIntoLineBreaks)return this;let i;i=t?$(t,e):$(e),i.each((e,t)=>{se.brToLR(t)})}return this}static insertBRTagIfLeadingSpaces(e){const t=e.currentTarget,n=t.selectionStart;if(!n)return;const i=t.value.slice(0,n),r=re.exec(i);if(!r)return;t.selectionEnd;W(t,"<br>",n-r[1].length,n)}static brToLR(e){const t=ne(e.value);if(t===e.value)return;const n=e.selectionStart,i=e.selectionEnd||n,r=e.value;e.value=t;const s=e.value.length-r.length;null!==n&&null!==i&&e.setSelectionRange(n+s,i+s)}}class oe{constructor(e,t=oe.DEFAULT_ROWS){this.defaultClassName=e,this.rows=t}enable(e,t){t=t||this.defaultClassName;const n=new WeakMap,i=new WeakMap,r=$(e).get().map(e=>{const n=e;return{textarea:oe.insertTextareaBefore(n,this.rows,t),input:n}}).filter(e=>e.textarea);return r.forEach(e=>{n.set(e.input,e.textarea),i.set(e.textarea,e.input)}),$(r.map(e=>e.input)).on("keyup",e=>{const t=e.currentTarget;n.get(t).value=ne(t.value)}),$(r.map(e=>e.textarea)).on("input",e=>{const t=e.currentTarget;i.get(t).value=ie(t.value)}).closest("form").on("submit",()=>{r.forEach(e=>e.input.value=ie(e.textarea.value))}),{inputTextAreas:r,inputToTextArea:n,textAreaToInput:i}}static insertTextareaBefore(e,t,n){if("text"!==e.type.toLowerCase())return null;e.style.display="none";const i=$("<textarea/>").insertBefore(e)[0];return i.className=e.className,n&&i.classList.add(n),i.style.width=e.style.width,i.rows=t,i.defaultValue=e.defaultValue,i.value=e.value,i.onkeyup=e.onkeyup,i}}oe.DEFAULT_ROWS=3;class ae extends oe{constructor(e,t=oe.DEFAULT_ROWS){super(e,t),this.defaultClassName=e,this.rows=t}enable(e,t){const n=super.enable(e,t),i=CPSE,r=CPSEALL;return CPSE=e=>{const t=$(`select[id=SL${e}]`).val();i(e);const r=$("table[id^=SET]").filter((e,t)=>"none"!==t.style.display).first();"0"!==t&&$(n.inputTextAreas.map(e=>e.input)).filter((e,t)=>$(t).closest(r).length>0).trigger("keyup")},CPSEALL=e=>{const t=$(`select[id=SL${e}]`).val();if(r(e),"0"!==t){const e=$(`table[id=SET${t}]`).first();$(n.inputTextAreas.map(e=>e.input)).filter((t,n)=>0===$(n).closest(e).length).trigger("keyup")}},n}}class le{constructor(){this.submitted=!1}enable(e,t){const n=function(e){this.submitted&&e.preventDefault(),this.submitted=!0};t?$(e).on("submit",t,n):$(e).on("submit",n)}}var ce=n(7),he=n.n(ce);class ue{constructor(e,t){if("number"==typeof e)this.start=e,this.end=t;else{const t=e;if(null===t.selectionStart||null===t.selectionEnd)throw new Error("invalid operation: selection start or end is null.");this.start=t.selectionStart,this.end=t.selectionEnd}}offset(e,t){return new ue(this.start+e,this.end+(null!=t?t:e))}select(e,t=0,n=0){e.setSelectionRange(this.start+t,this.end+n)}insertText(e,t){return W(e,t,this.start,this.end),ue.build(e)}insertBackspace(e){let t,n;return this.start===this.end?(t=Math.max(this.start-1,0),n=this.start):(t=this.start,n=this.end),W(e,"",t,n),ue.build(e)}static build(e){return null===e.selectionStart||null===e.selectionEnd?null:new ue(e)}}n(15);class de{constructor(){this.$helper=this.$initTagHelper(),this.sElem=null,this.storedSelection=null,this.tagEndSelection=null,this.outerTagSelection=null,this.hidingTimeoutId=0,this.hidingTimeoutMS=200}enable(e,t){const n=e=>{const t=e.currentTarget;t===this.sElem&&this.storedSelection&&this.storedSelection.start===t.selectionStart&&this.storedSelection.end===t.selectionEnd||(this.clearTagInsertedCondition(),this.setCurrentSelection(t)),this.show()};return O($(e),t,n).on({blur:e=>{this.setCurrentSelection(e.currentTarget),this.setHidingHelperTimeout()},mouseenter:e=>{this.sElem===e.currentTarget&&this.show()},mouseleave:e=>{this.sElem===e.currentTarget&&this.setHidingHelperTimeout()},keydown:e=>{this.storedSelection&&this.tagEndSelection&&(e.ctrlKey||e.altKey||!(8===e.keyCode||9===e.keyCode||e.keyCode>=48&&e.keyCode<=57||e.keyCode>=65&&e.keyCode<=90||e.keyCode>=97&&e.keyCode<=122)||(e.preventDefault(),8===e.keyCode?this.backspaceOnTag():9===e.keyCode?this.selectOuterTagEnd():this.insertCharOnTag(e.key)))},keyup:n},t),this}show(){if(!this.sElem)return;this.clearHidingHelperTimeout();const e=$(this.sElem).offset();this.$helper.css({left:e.left,top:e.top-this.$helper.height()}).show()}hide(){this.$helper.hide()}setHidingHelperTimeout(){this.hidingTimeoutId=setTimeout(()=>this.hide(),this.hidingTimeoutMS)}clearHidingHelperTimeout(){clearTimeout(this.hidingTimeoutId),this.hidingTimeoutId=0}insertTag(e,t,n,i=0){if(!this.sElem||!this.storedSelection)return;let r,s;r=this.outerTagSelection?t?this.outerTagSelection:new ue(this.outerTagSelection.end,this.outerTagSelection.end):this.storedSelection,s=t?`<${e}>`+this.sElem.value.slice(r.start,r.end)+`</${e}>`:`<${e}>`,W(this.sElem,s,r.start,r.end),this.outerTagSelection=new ue(r.start,r.start+s.length),this.storedSelection=new ue(r.start+n+1,r.start+n+1+i),this.tagEndSelection=t?new ue(r.end+e.length+n+4,r.end+e.length+n+4+i):this.storedSelection,this.selectStoredSelection()}backspaceOnTag(){if(!(this.sElem&&this.storedSelection&&this.tagEndSelection&&this.outerTagSelection))return;const e=this.tagEndSelection;this.tagEndSelection=this.tagEndSelection.insertBackspace(this.sElem);const t=this.tagEndSelection.start-e.end;e!==this.storedSelection?(this.outerTagSelection=this.outerTagSelection.offset(0,2*t),this.storedSelection=this.storedSelection.insertBackspace(this.sElem),this.tagEndSelection=this.tagEndSelection.offset(t)):this.outerTagSelection=this.outerTagSelection.offset(0,t)}insertCharOnTag(e){if(!(this.sElem&&this.storedSelection&&this.tagEndSelection&&this.outerTagSelection))return;const t=this.tagEndSelection;this.tagEndSelection=this.tagEndSelection.insertText(this.sElem,e);const n=this.tagEndSelection.start-t.end;t!==this.storedSelection?(this.outerTagSelection=this.outerTagSelection.offset(0,2*n),this.storedSelection=this.storedSelection.insertText(this.sElem,e),this.tagEndSelection=this.tagEndSelection.offset(n)):this.outerTagSelection=this.outerTagSelection.offset(0,n)}selectOuterTagEnd(){this.sElem&&this.outerTagSelection&&this.sElem.setSelectionRange(this.outerTagSelection.end,this.outerTagSelection.end)}$initTagHelper(){return O($(he.a).appendTo(document.body),"span",e=>{if(e.preventDefault(),!this.sElem)return;let t,n,i;this.clearHidingHelperTimeout();let r=0;switch(e.currentTarget.className){case"TagF":t="f3",n=!0,i=1,r=1;break;case"TagB":t="b",n=!0,i=1;break;case"TagI":t="i",n=!0,i=1;break;case"TagS":t="s",n=!0,i=1;break;case"TagU":t="u",n=!0,i=1;break;case"TagBR":t="br",n=!1,i=3;break;case"TagDice":t="1d6",n=!1,i=0,r=1;break;default:throw new Error("not implemented")}this.insertTag(t,n,i,r),$(this.sElem).triggerHandler("keyup")}).on("mouseenter",e=>{this.clearHidingHelperTimeout()}).on("mouseleave",e=>{this.setHidingHelperTimeout()})}setCurrentSelection(e){this.sElem=e,this.storedSelection=ue.build(e)}clearTagInsertedCondition(){this.tagEndSelection=null,this.outerTagSelection=null}selectStoredSelection(e=0,t=0){this.sElem&&this.storedSelection&&this.storedSelection.select(this.sElem,e,t)}}const pe=$(F.a).filter("span.B2").first().html();function be(e,t,n){let i,r,s;i=t?$(t,e):$(e),n?(r=i.find(".SE1 + div.CL").filter((e,t)=>0===$(t).parents(n).length),s=i.find("span.B2").filter((e,t)=>0===$(t).parents(n).length)):(r=i.find(".SE1 + div.CL"),s=i.find("span.B2")),r.prev().addBack().remove(),s.filter((e,t)=>t.innerHTML.startsWith(pe)).next("br").addBack().remove()}var fe=function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function a(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}l((i=i.apply(e,t||[])).next())}))};class ge{constructor(e,t){if(this.db=null,"name"in e)this.db=e,this.dbPromise=Promise.resolve(this.db),this.dbName=this.db.name,this.tableName=t,this.dbVersion=this.db.version;else{this.dbName=e.dbName,this.tableName=e.tableName,this.dbVersion=e.dbVersion,e.objectStoreParameters&&(this.objectStoreParameters=Object.freeze(Object.assign({},e.objectStoreParameters)))}}get DBPromise(){return this.dbPromise}get DBIsOpen(){return!!this.db}open(e){const t=indexedDB.open(this.dbName,this.dbVersion);return this.dbPromise=new Promise((n,i)=>{const r=this;t.onsuccess=function(e){r.db=this.result,n(r.db)},t.onerror=function(e){r.db=null,i("db error")},t.onupgradeneeded=function(t){const n=this.result;if(n.objectStoreNames.contains(r.tableName))e&&e(n,t);else{n.createObjectStore(r.tableName,r.objectStoreParameters)}n.onversionchange=e=>{n.close(),alert("データベースが更新されました。ページを再読込してください。")}},t.onblocked=function(e){i("blocked: db is already open.")}})}close(){var e;null===(e=this.db)||void 0===e||e.close()}count(e){if(!this.db)throw this.throwDBIsNotReadyError();const t=this.db.transaction(this.tableName,"readonly").objectStore(this.tableName).count(e);return new Promise((e,n)=>{t.onsuccess=function(t){e(this.result)},t.onerror=function(e){n("db error")}})}get(e){if(!this.db)throw this.throwDBIsNotReadyError();const t=this.db.transaction(this.tableName,"readonly").objectStore(this.tableName).get(e);return new Promise((e,n)=>{t.onsuccess=function(t){e(this.result)},t.onerror=function(e){n("db error")}})}getAll(e,t){if(!this.db)throw this.throwDBIsNotReadyError();const n=this.db.transaction(this.tableName,"readonly").objectStore(this.tableName).getAll(e,t);return new Promise((e,t)=>{n.onsuccess=function(t){e(this.result)},n.onerror=function(e){t("db error")}})}getAllDescending(e,t){return fe(this,void 0,void 0,(function*(){const n=[];if(void 0===t)return yield this.iterate(e=>(n.push(e),!1),e,"prev"),n;let i=t;return i<=0?n:(yield this.iterate(e=>(n.push(e),0==--i),e,"prev"),n)}))}getKey(e){if(!this.db)throw this.throwDBIsNotReadyError();const t=this.db.transaction(this.tableName,"readonly").objectStore(this.tableName).getKey(e);return new Promise((e,n)=>{t.onsuccess=function(t){e(this.result)},t.onerror=function(e){n("db error")}})}getAllKeys(e,t){if(!this.db)throw this.throwDBIsNotReadyError();const n=this.db.transaction(this.tableName,"readonly").objectStore(this.tableName).getAllKeys(e,t);return new Promise((e,t)=>{n.onsuccess=function(t){e(this.result)},n.onerror=function(e){t("db error")}})}add(e,t){if(!this.db)throw this.throwDBIsNotReadyError();const n=this.db.transaction(this.tableName,"readwrite").objectStore(this.tableName);return this._add(n,e,t)}bulkAdd(e){if(!this.db)throw this.throwDBIsNotReadyError();const t=this.db.transaction(this.tableName,"readwrite").objectStore(this.tableName);return this._addMany(t,e)}put(e,t){if(!this.db)throw this.throwDBIsNotReadyError();const n=this.db.transaction(this.tableName,"readwrite").objectStore(this.tableName);return this._put(n,e,t)}bulkPut(e){if(!this.db)throw this.throwDBIsNotReadyError();const t=this.db.transaction(this.tableName,"readwrite").objectStore(this.tableName);return this._putMany(t,e)}delete(e){if(!this.db)throw this.throwDBIsNotReadyError();const t=this.db.transaction(this.tableName,"readwrite").objectStore(this.tableName);return this._delete(t,e)}bulkDelete(e){if(!this.db)throw this.throwDBIsNotReadyError();const t=this.db.transaction(this.tableName,"readwrite").objectStore(this.tableName);return this._deleteMany(t,e)}clear(){if(!this.db)throw this.throwDBIsNotReadyError();const e=this.db.transaction(this.tableName,"readwrite").objectStore(this.tableName);return this._clear(e)}replaceAll(e){return fe(this,void 0,void 0,(function*(){if(!this.db)throw this.throwDBIsNotReadyError();const t=this.db.transaction(this.tableName,"readwrite").objectStore(this.tableName);return yield this._clear(t),yield this._addMany(t,e)}))}openCursor(e,t,n){if(!this.db)throw this.throwDBIsNotReadyError();return this.db.transaction(this.tableName,n).objectStore(this.tableName).openCursor(e,t)}openKeyCursor(e,t,n){if(!this.db)throw this.throwDBIsNotReadyError();return this.db.transaction(this.tableName,n).objectStore(this.tableName).openKeyCursor(e,t)}iterate(e,t,n,i){const r=this.openCursor(t,n,i);return new Promise((t,n)=>{r.onsuccess=function(n){const i=this.result;i?e(i.value,i)?t():i.continue():t()},r.onerror=function(e){n("db error")}})}iterateKey(e,t,n,i){const r=this.openKeyCursor(t,n,i);return new Promise((t,n)=>{r.onsuccess=function(n){const i=this.result;i?e(i.key,i)?t():i.continue():t()},r.onerror=function(e){n("db error")}})}_clear(e){const t=e.clear();return new Promise((e,n)=>{t.onsuccess=function(t){e()},t.onerror=function(e){n("db error")}})}_add(e,t,n){const i=e.add(t,n);return new Promise((e,t)=>{i.onsuccess=function(t){e(this.result)},i.onerror=function(e){t("db error")}})}_addMany(e,t){return fe(this,void 0,void 0,(function*(){if(0===t.length)return[];const n=[];for(const i of t)n.push(yield this._add(e,i));return n}))}_put(e,t,n){const i=e.put(t,n);return new Promise((e,t)=>{i.onsuccess=function(t){e(this.result)},i.onerror=function(e){t("db error")}})}_putMany(e,t){return fe(this,void 0,void 0,(function*(){if(0===t.length)return[];const n=[];for(const i of t)n.push(yield this._put(e,i));return n}))}_delete(e,t){if(!this.db)throw this.throwDBIsNotReadyError();const n=e.delete(t);return new Promise((e,t)=>{n.onsuccess=function(t){e()},n.onerror=function(e){t("db error")}})}_deleteMany(e,t){return fe(this,void 0,void 0,(function*(){if(0!==t.length)for(const n of t)yield this._delete(e,n)}))}throwDBIsNotReadyError(){throw new Error("DBの準備が完了していません。Promiseを参照してDBが開けるまで待機してください。")}}class me{constructor(e){e?this.db=new ge(e,me.TABLE_NAME):(this.db=new ge({dbName:C,dbVersion:k,tableName:me.TABLE_NAME,objectStoreParameters:me.TABLE_INITIALIZER}),this.db.open())}get DBPromise(){return new Promise((e,t)=>{this.db.DBPromise.then(()=>e(),e=>t(e))})}get DBIsOpen(){return this.db.DBIsOpen}get(){return this.db.get(me.DB_KEY)}put(e){return e.id=me.DB_KEY,this.db.put(e)}}me.TABLE_NAME="Settings",me.TABLE_INITIALIZER=Object.freeze({autoIncrement:!1,keyPath:"id"}),me.DB_KEY=0;var ve=n(8),we=n.n(ve),Te=n(9),Se=n.n(Te),Ee=(n(17),function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function a(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}l((i=i.apply(e,t||[])).next())}))});const ye={enablePreview:!0,enableInputToTextarea:!0,enableTagHelper:!0,enableTagCompletion:!0,enableEZFormSub:!0,enableBRConverter:!0,enableMultipleSubDenier:!0,enableIconIndexer:!0};class xe{constructor(e){this.db=new me,this.$settingsButton=this.initSettingsButton(),this.$settingsForm=this.initSettingsForm(),this.db=new me(e)}static initSettings(){return Object.assign({},ye)}enableDOMFunction(){return this.$settingsButton.appendTo($(".SHIDARI")),this}showForm(){this.$settingsForm.prependTo(document.body)}hideForm(){this.$settingsForm.detach()}applyToForm(){this.settings||(this.settings=xe.initSettings()),this.$settingsForm.find("#EnablePreview").prop("checked",this.settings.enablePreview),this.$settingsForm.find("#EnableInputToTextarea").prop("checked",this.settings.enableInputToTextarea),this.$settingsForm.find("#EnableTagHelper").prop("checked",this.settings.enableTagHelper),this.$settingsForm.find("#EnableTagCompletion").prop("checked",this.settings.enableTagCompletion),this.$settingsForm.find("#EnableEZFormSub").prop("checked",this.settings.enableEZFormSub),this.$settingsForm.find("#EnableBRConverter").prop("checked",this.settings.enableBRConverter),this.$settingsForm.find("#EnableMultipleSubDenier").prop("checked",this.settings.enableMultipleSubDenier),this.$settingsForm.find("#EnableIconIndexer").prop("checked",!!this.settings.enableIconIndexer)}extractFromForm(){return this.settings?(this.settings.enablePreview=this.$settingsForm.find("#EnablePreview").prop("checked"),this.settings.enableInputToTextarea=this.$settingsForm.find("#EnableInputToTextarea").prop("checked"),this.settings.enableTagHelper=this.$settingsForm.find("#EnableTagHelper").prop("checked"),this.settings.enableTagCompletion=this.$settingsForm.find("#EnableTagCompletion").prop("checked"),this.settings.enableEZFormSub=this.$settingsForm.find("#EnableEZFormSub").prop("checked"),this.settings.enableBRConverter=this.$settingsForm.find("#EnableBRConverter").prop("checked"),this.settings.enableMultipleSubDenier=this.$settingsForm.find("#EnableMultipleSubDenier").prop("checked"),this.settings.enableIconIndexer=this.$settingsForm.find("#EnableIconIndexer").prop("checked"),this.settings):xe.initSettings()}loadOrInit(){return Ee(this,void 0,void 0,(function*(){yield this.db.DBPromise;const e=yield this.db.get();return this.settings=e||xe.initSettings(),this.settings}))}save(){return Ee(this,void 0,void 0,(function*(){this.settings&&(yield this.db.DBPromise,yield this.db.put(this.settings))}))}initSettingsButton(){const e=$(Se.a);return O(e,e=>Ee(this,void 0,void 0,(function*(){this.$settingsForm.parent().length>0?this.hideForm():(this.settings||(yield this.loadOrInit()),yield this.loadOrInit(),this.applyToForm(),this.showForm())}))),e}initSettingsForm(){const e=$(we.a);return O(e,".SaveSettings",e=>Ee(this,void 0,void 0,(function*(){this.extractFromForm(),yield this.save(),this.hideForm()}))),O(e,".CancelSetting",e=>Ee(this,void 0,void 0,(function*(){this.hideForm()}))),e}}class Ie{constructor(e,t){this.dbName=e,this.dbVersion=t,this.dbTableNames=new Set,this.initializers=new Map,this.migrationListners=new Map,this.dbIsInitialized=!1}get DBIsInitialized(){return this.dbIsInitialized}get DBPromise(){return this.dbPromise?this.dbPromise:Promise.reject("db has not been tried to open.")}addTable(e,t,n){if(this.dbTableNames.has(e))throw new Error("this tableName "+e+" has already been added.");this.dbTableNames.add(e),this.initializers.set(e,t),n&&this.migrationListners.set(e,n)}initThenOpen(){return this.dbPromise=new Promise((e,t)=>{const n=indexedDB.open(this.dbName,this.dbVersion);this.dbIsInitialized=!0,n.onsuccess=function(t){e(this.result)},n.onerror=function(e){t("failed to open talkutil db")},n.onupgradeneeded=e=>{const t=n.result;this.dbTableNames.forEach(n=>{const i=this.migrationListners.get(n);t.objectStoreNames.contains(n)?i&&i(t,e):t.createObjectStore(n,this.initializers.get(n))}),t.onversionchange=e=>{t.close(),alert("データベースが更新されました。ページを再読込してください。")}},n.onblocked=function(e){t("blocked: db is already open.")}})}}class Ae{static enableObservation(e,t,n){new MutationObserver((e,i)=>Ae.observationListner(e,i,t,n)).observe(e,{childList:!0,subtree:!0})}static applyTo(e){$(e).each((e,t)=>{$(t).children("option").filter((e,t)=>!!t.value).each((e,t)=>{t.innerHTML=t.value+": "+t.innerHTML})})}static observationListner(e,t,n,i){e.forEach(e=>{Array.from(e.addedNodes).filter(e=>Ae.isFormInserted(e,n)).map(e=>Ae.selectIconSelect(e,i)).forEach(e=>{e.forEach(e=>{Ae.applyTo(e)})})})}static isFormInserted(e,t){if(e.nodeType!==Node.ELEMENT_NODE)return!1;const n=e;if("form"!==n.tagName.toLowerCase())return!1;const i=n.getAttribute("name");return!t||!!i&&i.startsWith(t)}static selectIconSelect(e,t){const n=Array.from(e.getElementsByTagName("select"));return t?n.filter(e=>{const n=e.getAttribute("name");return!!n&&n.startsWith(t)}):n}}var Ce=function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function o(e){try{l(i.next(e))}catch(e){s(e)}}function a(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}l((i=i.apply(e,t||[])).next())}))};(class{static select(){return Ce(this,void 0,void 0,(function*(){const e=yield this.loadThenEnableSettings();switch(document.location.pathname){case"/ib/act_main.php":case"/ib/act_trade.php":case"/ib/act_card.php":this.main(e);break;case"/ib/act_battle.php":this.battle(e);break;case"/ib/act_se.php":this.serif(e);break;case"/ib/act_aide.php":this.aide(e);break;case"/ib/act_chat.php":case"/ib/act_comu.php":this.chat(e);break;case"/ib/act_chara.php":this.chara(e);break;case"/ib/act_np.php":this.np(e)}}))}static main(e){const t=$("input[type='text']").filter((e,t)=>/^dt_.*?mes\d*$/.test(t.getAttribute("name")||"")),n=$("textarea[name='dt_nikki']");let i;if(e.enableInputToTextarea){const e=(new oe).enable(t);i=$(e.inputTextAreas.map(e=>e.textarea))}else i=t;const r=i.prev("select");this.enableCommonUtilityFuncs(i.add(n),r,e),e.enableBRConverter&&(new se).enable(i).enable(n,void 0,{convertsBRTagsIntoLineBreaks:!1}),e.enablePreview&&this.enableSerifPreview({$serifIcons:r,$serifTexts:i,selectorExcludingSerifRemoval:"#NPVHD"})}static battle(e){const t=$("input[type='text']").filter((e,t)=>/^dt_.*?ms\d*(?:-\d*)?$/.test(t.getAttribute("name")||""));let n;if(e.enableInputToTextarea){const e=(new ae).enable(t);n=$(e.inputTextAreas.map(e=>e.textarea))}else n=t;const i=n.map((e,t)=>$(t).prevUntil("select").last().prev()[0]);if(this.enableAllUtilityFuncs(n,i,e),e.enablePreview){const e=this.getIdFromLocation();let t;e&&(t={nickname:$("a[href^='act_battle.php'] > span.Y3").html().slice(1,-1),subIconNicknames:P.load(e)});const r=new WeakMap,s=new WeakMap;n.each((e,t)=>{const n=i.get(e);r.set(n,t),s.set(t,n)}),this.enableSerifPreview({$serifIcons:i,$serifTexts:n,iconToText:e=>r.get(e),textToIcon:e=>s.get(e),characterInfo:t})}}static serif(e){const t=$("input[type='text']").filter((e,t)=>/^dt_se\d*(?:-\d*)?$/.test(t.getAttribute("name")||""));let n;if(e.enableInputToTextarea){const e=(new ae).enable(t);n=$(e.inputTextAreas.map(e=>e.textarea))}else n=t;const i=n.prev("select");if(this.enableAllUtilityFuncs(n,i,e),e.enablePreview){const e=this.getIdFromLocation();let t;e&&(t={nickname:$("a[href^='act_se.php'] > span.Y3").html().slice(1,-1),subIconNicknames:P.load(e)}),this.enableSerifPreview({$serifIcons:i,$serifTexts:n,characterInfo:t})}}static aide(e){if(e.enablePreview){const e=$("tr[id^='EDIT']").filter((e,t)=>/\d+$/.test(t.id)).get().map(e=>/\d+$/.exec(e.id)[0]);for(const t of e)P.extract(t)}}static chat(e){const t=$("textarea[name='dt_mes']"),n=t.next().next("select");this.enableAllUtilityFuncs(t,n,e),e.enablePreview&&this.enableMessagePreview(n,t,t.next().next().next("input[type='text']"))}static np(e){const t=$("input[type='text']").filter((e,t)=>/^dt_.*?mes\d*$/.test(t.getAttribute("name")||""));let n;if(e.enableInputToTextarea){const e=(new oe).enable(t).inputTextAreas.map(e=>e.textarea);n=$(e)}else n=t;const i=n.prev("select");e.enableMultipleSubDenier&&(new le).enable(document.body,"form"),e.enableEZFormSub&&(new K).enable(t),e.enableIconIndexer&&Ae.applyTo(i)}static chara(e){e.enablePreview&&P.extract()}static enableHelp(){new z(C).enable(document.body,".PreviewHeader")}static enableAllUtilityFuncs(e,t,n){this.enableCommonUtilityFuncs(e,t,n),n.enableBRConverter&&(new se).enable(e)}static enableCommonUtilityFuncs(e,t,n){n.enableMultipleSubDenier&&(new le).enable(document.body,"form"),n.enableEZFormSub&&(new K).enable(e),n.enableTagCompletion&&(new ee).enable(e),n.enableTagHelper&&(new de).enable(e),n.enableIconIndexer&&Ae.applyTo(t)}static enableSerifPreview(e){this.enableHelp(),be(document.body,void 0,e.selectorExcludingSerifRemoval),new U(N,!1,e.characterInfo).enableSerifPreview(e.$serifIcons,e.$serifTexts,e.iconToText,e.textToIcon,!0)}static enableMessagePreview(e,t,n){this.enableHelp(),new H(N).enableMessagePreview(e,t,n,t.closest("div"))}static getIdFromLocation(){if(!document.location.search)return;const e=/^a=(\d+)$/,t=document.location.search.substring(1).split("&").find(t=>e.test(t));return t?e.exec(t)[1]:void 0}static loadThenEnableSettings(){return Ce(this,void 0,void 0,(function*(){const e=new Ie(C,k);e.addTable(me.TABLE_NAME,me.TABLE_INITIALIZER);const t=yield e.initThenOpen(),n=new xe(t),i=yield n.loadOrInit();return n.enableDOMFunction(),i}))}}).select()}]);