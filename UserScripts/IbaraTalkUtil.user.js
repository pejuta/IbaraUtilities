// ==UserScript==
// @name        IbaraTalkUtil
// @namespace   https://twitter.com/11powder
// @description 交流ってスバラシティ
// @include     http://lisge.com/ib/talk.php*
// @version     1.0.14
// @updateURL   https://pejuta.github.io/IbaraUtilities/UserScripts/IbaraTalkUtil.user.js
// @downloadURL https://pejuta.github.io/IbaraUtilities/UserScripts/IbaraTalkUtil.user.js
// @grant       none
// ==/UserScript==
!function(t){var e={};function n(r){if(e[r])return e[r].exports;var i=e[r]={i:r,l:!1,exports:{}};return t[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)n.d(r,i,function(e){return t[e]}.bind(null,i));return r},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=26)}([function(t,e,n){"use strict";t.exports=function(t){var e=[];return e.toString=function(){return this.map((function(e){var n=function(t,e){var n=t[1]||"",r=t[3];if(!r)return n;if(e&&"function"==typeof btoa){var i=(o=r,"/*# sourceMappingURL=data:application/json;charset=utf-8;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(o))))+" */"),s=r.sources.map((function(t){return"/*# sourceURL="+r.sourceRoot+t+" */"}));return[n].concat(s).concat([i]).join("\n")}var o;return[n].join("\n")}(e,t);return e[2]?"@media "+e[2]+"{"+n+"}":n})).join("")},e.i=function(t,n){"string"==typeof t&&(t=[[null,t,""]]);for(var r={},i=0;i<this.length;i++){var s=this[i][0];null!=s&&(r[s]=!0)}for(i=0;i<t.length;i++){var o=t[i];null!=o[0]&&r[o[0]]||(n&&!o[2]?o[2]=n:n&&(o[2]="("+o[2]+") and ("+n+")"),e.push(o))}},e}},function(t,e,n){var r,i,s={},o=(r=function(){return window&&document&&document.all&&!window.atob},function(){return void 0===i&&(i=r.apply(this,arguments)),i}),a=function(t,e){return e?e.querySelector(t):document.querySelector(t)},l=function(t){var e={};return function(t,n){if("function"==typeof t)return t();if(void 0===e[t]){var r=a.call(this,t,n);if(window.HTMLIFrameElement&&r instanceof window.HTMLIFrameElement)try{r=r.contentDocument.head}catch(t){r=null}e[t]=r}return e[t]}}(),c=null,h=0,d=[],u=n(15);function p(t,e){for(var n=0;n<t.length;n++){var r=t[n],i=s[r.id];if(i){i.refs++;for(var o=0;o<i.parts.length;o++)i.parts[o](r.parts[o]);for(;o<r.parts.length;o++)i.parts.push(S(r.parts[o],e))}else{var a=[];for(o=0;o<r.parts.length;o++)a.push(S(r.parts[o],e));s[r.id]={id:r.id,refs:1,parts:a}}}}function v(t,e){for(var n=[],r={},i=0;i<t.length;i++){var s=t[i],o=e.base?s[0]+e.base:s[0],a={css:s[1],media:s[2],sourceMap:s[3]};r[o]?r[o].parts.push(a):n.push(r[o]={id:o,parts:[a]})}return n}function f(t,e){var n=l(t.insertInto);if(!n)throw new Error("Couldn't find a style target. This probably means that the value for the 'insertInto' parameter is invalid.");var r=d[d.length-1];if("top"===t.insertAt)r?r.nextSibling?n.insertBefore(e,r.nextSibling):n.appendChild(e):n.insertBefore(e,n.firstChild),d.push(e);else if("bottom"===t.insertAt)n.appendChild(e);else{if("object"!=typeof t.insertAt||!t.insertAt.before)throw new Error("[Style Loader]\n\n Invalid value for parameter 'insertAt' ('options.insertAt') found.\n Must be 'top', 'bottom', or Object.\n (https://github.com/webpack-contrib/style-loader#insertat)\n");var i=l(t.insertAt.before,n);n.insertBefore(e,i)}}function m(t){if(null===t.parentNode)return!1;t.parentNode.removeChild(t);var e=d.indexOf(t);e>=0&&d.splice(e,1)}function g(t){var e=document.createElement("style");if(void 0===t.attrs.type&&(t.attrs.type="text/css"),void 0===t.attrs.nonce){var r=function(){0;return n.nc}();r&&(t.attrs.nonce=r)}return b(e,t.attrs),f(t,e),e}function b(t,e){Object.keys(e).forEach((function(n){t.setAttribute(n,e[n])}))}function S(t,e){var n,r,i,s;if(e.transform&&t.css){if(!(s="function"==typeof e.transform?e.transform(t.css):e.transform.default(t.css)))return function(){};t.css=s}if(e.singleton){var o=h++;n=c||(c=g(e)),r=E.bind(null,n,o,!1),i=E.bind(null,n,o,!0)}else t.sourceMap&&"function"==typeof URL&&"function"==typeof URL.createObjectURL&&"function"==typeof URL.revokeObjectURL&&"function"==typeof Blob&&"function"==typeof btoa?(n=function(t){var e=document.createElement("link");return void 0===t.attrs.type&&(t.attrs.type="text/css"),t.attrs.rel="stylesheet",b(e,t.attrs),f(t,e),e}(e),r=y.bind(null,n,e),i=function(){m(n),n.href&&URL.revokeObjectURL(n.href)}):(n=g(e),r=A.bind(null,n),i=function(){m(n)});return r(t),function(e){if(e){if(e.css===t.css&&e.media===t.media&&e.sourceMap===t.sourceMap)return;r(t=e)}else i()}}t.exports=function(t,e){if("undefined"!=typeof DEBUG&&DEBUG&&"object"!=typeof document)throw new Error("The style-loader cannot be used in a non-browser environment");(e=e||{}).attrs="object"==typeof e.attrs?e.attrs:{},e.singleton||"boolean"==typeof e.singleton||(e.singleton=o()),e.insertInto||(e.insertInto="head"),e.insertAt||(e.insertAt="bottom");var n=v(t,e);return p(n,e),function(t){for(var r=[],i=0;i<n.length;i++){var o=n[i];(a=s[o.id]).refs--,r.push(a)}t&&p(v(t,e),e);for(i=0;i<r.length;i++){var a;if(0===(a=r[i]).refs){for(var l=0;l<a.parts.length;l++)a.parts[l]();delete s[a.id]}}}};var w,F=(w=[],function(t,e){return w[t]=e,w.filter(Boolean).join("\n")});function E(t,e,n,r){var i=n?"":r.css;if(t.styleSheet)t.styleSheet.cssText=F(e,i);else{var s=document.createTextNode(i),o=t.childNodes;o[e]&&t.removeChild(o[e]),o.length?t.insertBefore(s,o[e]):t.appendChild(s)}}function A(t,e){var n=e.css,r=e.media;if(r&&t.setAttribute("media",r),t.styleSheet)t.styleSheet.cssText=n;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(n))}}function y(t,e,n){var r=n.css,i=n.sourceMap,s=void 0===e.convertToAbsoluteUrls&&i;(e.convertToAbsoluteUrls||s)&&(r=u(r)),i&&(r+="\n/*# sourceMappingURL=data:application/json;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(i))))+" */");var o=new Blob([r],{type:"text/css"}),a=t.href;t.href=URL.createObjectURL(o),a&&URL.revokeObjectURL(a)}},function(t,e){t.exports="<div style='position: absolute; z-index: 2;'><div class='SE3'><table cellpadding='0' cellspacing='0' class='SE0'><tr valign='TOP'>\r\n    <td width='70'><img src='p/iba_icon.png' class='RE2' alt='RE'></td>\r\n    <td class='F3'>\r\n        <a><span class='Y4'>{SCRIPT_NAME}の機能・使い方</span></a><br>\r\n            <div style='margin:10px;'>\r\n            ・入力した発言内容を自動的に解析してプレビューを表示します。<br>\r\n            ・入力欄の上あたりにタグ入力補助バーを表示します。<br>\r\n            ・<b class='O3'>Ctrl+Shift+Enterキー</b>を押すと発言内容を送信します。<br>\r\n            ・<b class='O3'>Tab</b>キーを押すと、閉じタグ(<b class='Y3'>&lt;/B&gt;, &lt;/f4&gt;</b>など)を自動的に補完します。<br>\r\n            ・タグ名(<b class='Y3'>i4, S</b>など)を入力してからTabキーを押すと、指定の装飾タグを自動入力します。<br>\r\n            　<span class='P3'>例： f5 ⇒ &lt;f5&gt&lt;/f5&gt</span><br>\r\n            <br>　(hint) 入力自動補完に対応しているタグ名の一覧（小文字可、半角のみ）：<br><b class='Y3'>\r\n                　　 F[1-7] B B[1-7] I I[1-7] S S[1-7] U U[1-7]\r\n            </b>\r\n            </div>\r\n    </td>\r\n</tr></table></div></div>"},function(t,e){t.exports="<div class='Preview'><div class='Y3 PreviewHeader'>《{PREVIEW_TYPE}プレビュー》 <a href='#'> [Help] </a></div><span class=\"PreviewBody\"></span></div>"},function(t,e){t.exports="<div class='{CNT_CLASS_NAME}'><table cellpadding='0' cellspacing='0' class='SE0'><tr valign='TOP'>\r\n   <td width='70'><img src='{ICON_URL}' class='RE2' alt='RE'></td>\r\n   <td class='F3'>\r\n       {RESPONSE}\r\n       <a href='#'><span class='Y3'>{SENDER_NAME}({SENDER_ENO})</span></a><br>{TALK_HTML}\r\n   </td>\r\n</tr></table></div>"},function(t,e){t.exports="<div class='Preview'><div class='SE2'>【ERROR】発言者名は{MAX_CHARS}文字以内です！（現在{CHARS}文字）</div></div>"},function(t,e){t.exports="<div class='SE2'>【ERROR】書き込み内容は{MAX_CHARS}文字以内です！（現在{CHARS}文字）</div>"},function(t,e){t.exports='<a href="talk.php?p={PLACE_ID}&amp;sno={TREE_ID}" target="_blank" class="F1">＞{RES_NAMES} <br></a>'},function(t,e){t.exports='<div class="{CLASS_NAME}">\r\n<table cellpadding="0" cellspacing="0" class="SE0"><tbody><tr valign="TOP"><td width="70" rowspan="2"><img src="{ICON_URL}" alt="RE" class="RE2"></td>\r\n<td class="F3"><a href="k/now/r{ENO}.html" target="_blank"><span class="Y3">{NAME}({ENO})</span></a><br>{RES_HTML}{BODY_HTML}</td></tr>\r\n<tr valign="BOTTOM"><td align="RIGHT" class="B1"><a href="./talk.php?p={PLACE_ID}" target="_blank"><span class="B1">at {PLACE_NAME}</span></a> {BR_IF_PLACENAME_LONG}({DATE})<a class="RE" style="display: none;" data-nn="{ID}"></a><a href="./talk.php?p={PLACE_ID}&sno={TREE_ID_OR_ID}" target="_blank"><span class="ShowTreeBtn"></span></a><span class="FavSearchBtn"><span class="FavSearchTxt">Fav検索</span><div class="FavSearchMenu"><span class="FavSearchOption OptionPlace">プレイス</span><span class="FavSearchOption OptionTree">発言ツリー</span><span class="FavSearchOption OptionENo">ENo.</span></div></span></td></tr></tbody></table>\r\n</div>'},function(t,e){t.exports='<div id="FavLine">\r\n    <div id="FavLineNav">\r\n        <div>\r\n            <div class="MS5 F4" style="position: absolute;">Hint: <span class="R5">Shiftキー</span>を押してみよう！</div>\r\n            <div id="FavControl">\r\n                <div id="FavControlMessage"></div>\r\n                <div>お気に入り発言データの…</div>\r\n                <div id="ExportFavs" class="FavButton BUTT3">ファイル出力</div>\r\n                <div id="ImportFavs" class="FavButton BUTT2">ファイル入力</div>\r\n                <div> </div>\r\n                <div id="DeleteFavs" class="FavButton BUTT1">全消去</div>\r\n            </div>\r\n        </div>\r\n        <div id="FavSearchBar">\r\n            <div id="FavLinePrev" class="BUT2"></div>\r\n            <div id="FavSearch">\r\n                <span>検索： </span>\r\n                <input type="text" class="TXT">\r\n                <select class="ARE">\r\n                    <option value="0">降順</option>\r\n                    <option value="1">昇順</option>\r\n                </select>\r\n            </div>\r\n            <div id="FavLineNext" class="BUT2"></div>\r\n        </div>\r\n    </div>\r\n    <div id="FavLineBody">\r\n        <div id="FavLeftLine"></div><div id="FavRightLine"></div>\r\n    </div>\r\n</div>'},function(t,e){t.exports="<div class='BigFavButton FavChatAll'></div><div class='BigFavButton RmFavChatAll'></div>"},function(t,e){t.exports='<div class="TagHelper">\r\n<span class="TagF"> F </span><span class="TagB"> B </span><span class="TagI"> I </span><span class="TagS"> S </span><span class="TagU"> U </span><span class="TagDice">1</span><span class="TagBR">BR</span>\r\n</div>'},function(t,e){t.exports='<div id="IbaraTalkUtilSettings" class="UtilSettings F3"><b class="Y4">IbaraTalkUtil 機能設定</b>\r\n<div class="SettingsBody"><input type="checkbox" id="EnablePreview">発言プレビューを表示する。\r\n<input type="checkbox" id="EnableFav">発言お気に入り機能を利用する。\r\n<input type="checkbox" id="EnableTagHelper">装飾タグ簡単入力バーを表示する。\r\n<input type="checkbox" id="EnableTagCompletion">装飾タグの自動入力・入力支援を利用する。\r\n<input type="checkbox" id="EnableEZFormSub">Ctrl+Shift+Enter押下で発言を送信する。\r\n<input type="checkbox" id="EnableBRConverter">送信時に消滅する改行の代わりにBRタグを挿入する。\r\n<input type="checkbox" id="EnableMultipleSubDenier">多重送信を防止する。\r\n<span class="P2">※ 設定はリロード後に有効になります。</span></div>\r\n<span class="SaveSettings SettingsButton BUTT3">保存して閉じる</span><span class="CancelSetting SettingsButton BUTT1">キャンセル</span></div>'},function(t,e,n){var r=n(14);"string"==typeof r&&(r=[[t.i,r,""]]);var i={hmr:!0,transform:void 0,insertInto:void 0};n(1)(r,i);r.locals&&(t.exports=r.locals)},function(t,e,n){(t.exports=n(0)(!1)).push([t.i,"@charset \"utf-8\";\r\n\r\ndiv.MXM > table[width='970']:first-of-type td[width='700'] {\r\n    /* say container */\r\n    max-width: 700px;\r\n    overflow: visible;\r\n}\r\n\r\ndiv.MXM > table[width='970']:first-of-type td[width='270'] {\r\n    /* say search */\r\n    vertical-align: top;\r\n    padding-top: 20px;\r\n}\r\n\r\n.SE3, .SE4 {\r\n    overflow: visible;\r\n    max-width: calc(100% - 20px);\r\n}\r\n\r\n.Preview .SE3, .Preview .SE4  {\r\n    max-width: initial;\r\n}\r\n",""])},function(t,e){t.exports=function(t){var e="undefined"!=typeof window&&window.location;if(!e)throw new Error("fixUrls requires window.location");if(!t||"string"!=typeof t)return t;var n=e.protocol+"//"+e.host,r=n+e.pathname.replace(/\/[^\/]*$/,"/");return t.replace(/url\s*\(((?:[^)(]|\((?:[^)(]+|\([^)(]*\))*\))*)\)/gi,(function(t,e){var i,s=e.trim().replace(/^"(.*)"$/,(function(t,e){return e})).replace(/^'(.*)'$/,(function(t,e){return e}));return/^(#|data:|http:\/\/|https:\/\/|file:\/\/\/|\s*$)/i.test(s)?t:(i=0===s.indexOf("//")?s:0===s.indexOf("/")?n+s:r+s.replace(/^\.\//,""),"url("+JSON.stringify(i)+")")}))}},function(t,e,n){var r=n(17);"string"==typeof r&&(r=[[t.i,r,""]]);var i={hmr:!0,transform:void 0,insertInto:void 0};n(1)(r,i);r.locals&&(t.exports=r.locals)},function(t,e,n){(t.exports=n(0)(!1)).push([t.i,'@charset "utf-8";\r\n\r\n.OneColumn .SE3 > table, .OneColumn .SE4 > table {\r\n    width: 900px;\r\n}\r\n.TwoColumns .SE3 > table, .TwoColumns .SE4 > table {\r\n    width: 440px;\r\n}',""])},function(t,e,n){var r=n(19);"string"==typeof r&&(r=[[t.i,r,""]]);var i={hmr:!0,transform:void 0,insertInto:void 0};n(1)(r,i);r.locals&&(t.exports=r.locals)},function(t,e,n){(t.exports=n(0)(!1)).push([t.i,'@charset "utf-8";\r\n\r\n.ShowTreeBtn {\r\n    cursor: pointer;\r\n    margin: 0 6px;\r\n    padding: 1px 4px 0 3px;\r\n    background: radial-gradient(#333300, #333300);\r\n    border: 1px solid #444400;\r\n}\r\n\r\n.ShowTreeBtn:hover {\r\n    background: radial-gradient(#446600, #333300);\r\n}\r\n\r\n.ShowTreeBtn:after {\r\n  content: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQAQMAAAAlPW0iAAAABGdBTUEAALGPC/xhBQAAAAZQTFRF3d1m3d1mcfl8VQAAAAJ0Uk5THPwk7y5SAAAAM0lEQVQI12P4U88ARAf4GQ7IMxywZjhQzHDgMcPBAwyHGxiOMzCcY2Y4w8xwAIz+/wciAMSjEyPQlGKaAAAAAElFTkSuQmCC);\r\n  position: relative;\r\n  top: 4px;\r\n  margin: 0 2px 0 4px;\r\n}\r\n\r\n.FavSearchBtn {\r\n    position: relative;\r\n    cursor: pointer;\r\n    margin: 0 6px;\r\n    padding: 1px 4px 0 3px;\r\n    background: radial-gradient(black, black);\r\n    border: #661111 solid 1px;\r\n}\r\n\r\n.FavSearchBtn:hover {\r\n    background: radial-gradient(#660000, black);\r\n    z-index: 1;\r\n}\r\n\r\n.FavSearchBtn:after {\r\n    content: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAAQBAMAAAAG6llRAAAABGdBTUEAALGPC/xhBQAAADBQTFRF//f4/1hp/////////+7w/3SC/7W8/1hp/56o/1lq//7+/////1hpAAAA/4yY/662W1lf9gAAAA50Uk5TT9bLevX+MKwWdqT+/gBwnctiAAAAo0lEQVQI12O4O/Hg3Bs1x3PvXmC4fubMwZwzZ04CmXPOnDlz9F3Mmd4LDDJAlvfuLTFzLzAABaOdGUy21oJFXXLvXnMBitacObfh7t273LwXGHLOnN8BZHbbXmC4eeb8XiDz9toLDHdrzm8DMrOBonevH90FZK4Gmnv37pzfK+527boLYt48v1tptzZIwd277VFKy25tBjPv9oIUG4CZIHBLAQBlcm7e9rH+cQAAAABJRU5ErkJggg==);\r\n    position: relative;\r\n    top: 4px;\r\n    margin: 0 0 0 2px;\r\n}\r\n\r\n.FavSearchBtn .FavSearchMenu {\r\n    position: absolute;\r\n    padding-bottom: 0;\r\n    bottom: -5px;\r\n    left: -5px;\r\n    font-size: 14px;\r\n    width: 6em;\r\n    overflow: hidden;\r\n    background-color: black;\r\n    border: inherit;\r\n}\r\n\r\n.FavSearchBtn > * {\r\n    display: none;\r\n}\r\n\r\n.FavSearchBtn:hover > * {\r\n    cursor: auto;\r\n    height: auto;\r\n    display: block;\r\n}\r\n\r\n.FavSearchBtn:hover .FavSearchMenu {\r\n    padding: 0.2em 0.2em calc(100% + 0.2em);\r\n    text-align: center;\r\n}\r\n\r\n.FavSearchOption {\r\n    cursor: pointer;\r\n    display: block;\r\n    margin: 0.15em 0;\r\n    color: #FF6666;\r\n    border-bottom: #992222 solid 1px;\r\n}\r\n\r\n.FavSearchBtn:hover .FavSearchTxt {\r\n    z-index: 1;\r\n    font-size: 12px;\r\n    font-weight: bold;\r\n    color: white;\r\n    position: absolute;\r\n    bottom: 0;\r\n    left: 100%;\r\n    width: 4em;\r\n}',""])},function(t,e,n){var r=n(21);"string"==typeof r&&(r=[[t.i,r,""]]);var i={hmr:!0,transform:void 0,insertInto:void 0};n(1)(r,i);r.locals&&(t.exports=r.locals)},function(t,e,n){(t.exports=n(0)(!1)).push([t.i,'@charset "utf-8";\r\n\r\n#FavLineNav > * {\r\n    margin-bottom: 10px;\r\n}\r\n\r\n#FavControl {\r\n    height: 22px;\r\n    max-height: 22px;\r\n    display: flex;\r\n    align-content: center;\r\n    justify-content: flex-end;\r\n    margin-left: 300px;\r\n    padding: 2px 0px;\r\n    align-items: center;\r\n    background: linear-gradient(90deg, transparent, rgba(255, 64, 64, 0.3));\r\n    border-right: 8px solid rgba(255, 64, 64, 0.35);\r\n}\r\n\r\n#FavControlMessage {\r\n    display: none;\r\n    line-height: 25px;\r\n    background-color: white;\r\n    border-radius: 5px;\r\n    z-index: 100;\r\n    text-align: center;\r\n    color: #CC6600;\r\n    font-size: 15px;\r\n    font-weight: bold;\r\n    margin: 0px 5px;\r\n    padding: 2px;\r\n}\r\n\r\n.FavButton {\r\n    margin: 0px 5px;\r\n    height: 20px;\r\n    line-height: inherit;\r\n}\r\n\r\n#FavSearchBar {\r\n    display: flex;\r\n    align-content: center;\r\n    justify-content: space-between;\r\n    padding: 2px;\r\n    align-items: center;\r\n}\r\n\r\n#FavLinePrev, #FavLineNext {\r\n    display: inline-block;\r\n    width: 200px;\r\n    text-align: center;\r\n}\r\n\r\n#FavSearch {\r\n    width: 500px;\r\n    text-align: center;\r\n}\r\n\r\n#FavSearch > input {\r\n    width: 360px;\r\n}\r\n\r\n.ShowFavsBtn {\r\n    color: #DD4444;\r\n    background-color: black;\r\n    border: #661111 solid 1px;\r\n    border-radius: 3px;\r\n    margin-left: 6px;\r\n    padding: 2px 4px 0px 4px;\r\n    font-size: 13.5px;\r\n    line-height: 30px;\r\n    cursor: pointer;\r\n    white-space: nowrap;\r\n    transition: 0.1s;\r\n}\r\n.ShowFavsBtn:hover {\r\n    border-color: #992222;\r\n    background-color: #660000;\r\n    color: #FF6666;\r\n}\r\n.ShowFavsBtn.Shown {\r\n    color: #EE5555;\r\n    border-color: #992222;\r\n    box-shadow: 0 0 6px 1px inset;\r\n}\r\n\r\n.FavChat {\r\n    display: inline-block;\r\n    height: 18px;\r\n    width: 25px;\r\n    position: relative;\r\n    top: 1px;\r\n    left: 1px;\r\n    color: #DD4444;\r\n    border: #661111 solid 1px;\r\n    background-color: #110000;\r\n    font-weight: normal;\r\n    font-size: 16px;\r\n    line-height: 120%;\r\n    cursor: pointer;\r\n    transition: 0.1s;\r\n    margin: 0 7px 0 5px;\r\n    text-align: center;\r\n}\r\n.FavChat:before {\r\n    content: "\\2661";\r\n    display: inline-block;\r\n    height: 100%;\r\n    padding: 0 4px;\r\n}\r\n.FavChat:hover {\r\n    color: #FF6666;\r\n    border-color: #992222;\r\n    background-color: #660000;\r\n}\r\n\r\n.FavChat.Favd {\r\n    color: #EE5555;\r\n    border-color: #992222;\r\n    font-size: 17px;\r\n    line-height: 110%;\r\n    text-shadow: 0 0 4px red;\r\n}\r\n.FavChat.Favd:before {\r\n    content: "\\2665";\r\n}\r\n\r\n\r\n.BigFavButton {\r\n    z-index: -1;\r\n    position: fixed;\r\n    opacity: 0;\r\n    height: 120px;\r\n    width: 120px;\r\n    font-size: 80px;\r\n    color: transparent;\r\n    text-shadow: 0 0 #DD4444;\r\n    box-shadow: 0 0 50px 25px #DD4444;\r\n    border: #661111 solid 4px;\r\n    border-radius: 120px;\r\n    background: radial-gradient(#110000, #110000);\r\n    line-height: 128px;\r\n    font-weight: normal;\r\n    cursor: pointer;\r\n    text-align: center;\r\n    transition: 0.15s;\r\n}\r\n\r\n.BigFavButton:before, .BigFavButton:After {\r\n    position: absolute;\r\n    height: 100%;\r\n}\r\n\r\n.BigFavButton, .BigFavButton:before, .BigFavButton:After {\r\n    display: block;\r\n    top: 0;\r\n    left: 0;\r\n    right: 0;\r\n    bottom: 0;\r\n    margin: auto;\r\n}\r\n\r\n.BigFavButton:after {\r\n    color: #DD4444;\r\n    text-shadow: 2px 2px 0 black,\r\n                 -2px 2px 0 black,\r\n                 2px -2px 0 black,\r\n                 -2px -2px 0 black;\r\n}\r\n\r\n.BigFavButton:hover {\r\n    text-shadow: 0 0 #FF3333;\r\n    box-shadow: 0 0 50px 25px #FF3333;\r\n    border-color: #992222;\r\n    background:  radial-gradient(#661111, #110000);\r\n    background-color: #660000;\r\n}\r\n.BigFavButton:hover:after {\r\n    color: #FF3333;\r\n}\r\n\r\n.BigFavButton.Shown {\r\n    opacity: 1;\r\n    z-index: 100;\r\n}\r\n\r\n\r\n.BigFavButton.FavChatAll {\r\n    right: 33%;\r\n}\r\n.BigFavButton.FavChatAll:before {\r\n    content: "\\2665";\r\n}\r\n.BigFavButton.FavChatAll:after {\r\n    font-size: 60px;\r\n    content: "ALL";\r\n}\r\n.BigFavButton.RmFavChatAll {\r\n    left: 33%;\r\n}\r\n.BigFavButton.RmFavChatAll:before {\r\n    content: "\\2661";\r\n}\r\n.BigFavButton.RmFavChatAll:after {\r\n    font-size: 136px;\r\n    line-height: 124px;\r\n    content: "×";\r\n}\r\n\r\n\r\n#FavLeftLine, #FavRightLine {\r\n    float: left;\r\n    padding: 0px 12px;\r\n}\r\n.OneColumn #FavLeftLine, .OneColumn #FavRightLine {\r\n    width: 920px;\r\n}\r\n.TwoColumns #FavLeftLine, .TwoColumns #FavRightLine {\r\n    width: 460px;\r\n}\r\n.OneColumn #FavLeftLine {\r\n    border-right: none;\r\n}\r\n.TwoColumns #FavLeftLine {\r\n    border-right: 1px solid rgb(51, 51, 51);\r\n}',""])},function(t,e,n){var r=n(23);"string"==typeof r&&(r=[[t.i,r,""]]);var i={hmr:!0,transform:void 0,insertInto:void 0};n(1)(r,i);r.locals&&(t.exports=r.locals)},function(t,e,n){(t.exports=n(0)(!1)).push([t.i,'@charset "utf-8";\r\n\r\n.TagHelper {\r\n    position: absolute;\r\n    width: 280px;\r\n    height: 20px;\r\n    z-index: 100;\r\n    display: none;\r\n}\r\n.TagHelper > span {\r\n    background: radial-gradient(rgba(0,0,0,0.9),rgba(0,0,0,0.9));\r\n    display: inline-block;\r\n    width: 40px;\r\n    height: 100%;\r\n    text-align: center;\r\n    line-height: 1em;\r\n    font-size: 20px;\r\n    white-space: pre;\r\n}\r\n.TagHelper > span:hover {\r\n    background: radial-gradient(rgba(95,0,0,0.9),rgba(0,0,0,0.9));\r\n}\r\n.TagF {\r\n    position: relative;\r\n}\r\n.TagF:after {\r\n    content:"F";\r\n    font-size: 11px;\r\n    line-height: 11px;\r\n    position: absolute;\r\n    left: 22px;\r\n    top: 7px;\r\n}\r\n.TagB {\r\n    font-weight: bold;\r\n}\r\n.TagI {\r\n    font-style: italic;\r\n}\r\n.TagS {\r\n    text-decoration: line-through;\r\n}\r\n.TagU {\r\n    text-decoration: underline;\r\n}\r\n.TagDice {\r\n    font-family: "dice", sans-serif;\r\n}\r\n',""])},function(t,e,n){var r=n(25);"string"==typeof r&&(r=[[t.i,r,""]]);var i={hmr:!0,transform:void 0,insertInto:void 0};n(1)(r,i);r.locals&&(t.exports=r.locals)},function(t,e,n){(t.exports=n(0)(!1)).push([t.i,".ShowTalkUtilSettingsBtn {\r\n    margin-left: 6px;\r\n}\r\n\r\n.UtilSettings {\r\n    position: fixed;\r\n    z-index: 999;\r\n    margin: auto;\r\n    top: 0;\r\n    right: 0;\r\n    bottom: 0;\r\n    left: 0;\r\n    width: 420px;\r\n    height: 200px;\r\n    background-color: rgba(0,0,0,0.95);\r\n    padding: 20px;\r\n    border-radius: 10px;\r\n}\r\n\r\n.SettingsBody {\r\n    margin: 4px;\r\n    white-space: pre-wrap;\r\n}\r\n.SettingsBody > input {\r\n    margin-right: 10px;\r\n}\r\n.SettingsButton  {\r\n    margin: 0 4px;\r\n    padding: 2px 20px;\r\n}",""])},function(t,e,n){"use strict";n.r(e);const r=/(?:\r\n|\r|\n)/g,i=/<br>/gi;function s(t){return t?t.replace(r,"<br>"):t}function o(t){return t?t.replace(i,"\n"):t}const a=/^[ \r\n\t\v]+/,l=/[ 　]+$/;const c=new RegExp("^[ \\r\\n\\t\\v]*<br>","i");const h=-1!==navigator.userAgent.toLowerCase().indexOf("firefox");function d(t,e,n,r){t.focus(),h?t.setRangeText(e,n,r,"end"):(t.setSelectionRange(n,r),document.execCommand("insertText",!1,e))}const u=new RegExp("^[ \\r\\n\\t\\v]*?((?:\\r\\n|\\r|\\n))$");class p{constructor(t=!0){this.convertsOnEnable=t}enable(t,e,n={}){const r=t=>{!1!==n.insertsLeadingBRs&&p.insertBRTagIfLeadingSpaces(t)};if(e?$(t).on("input",e,r):$(t).on("input",r),this.convertsOnEnable){if(!1===n.convertsBRTagsIntoLineBreaks)return this;let r;r=e?$(e,t):$(t),r.each((t,e)=>{p.brToLR(e)})}return this}static insertBRTagIfLeadingSpaces(t){const e=t.currentTarget,n=e.selectionStart;if(!n)return;const r=e.value.slice(0,n),i=u.exec(r);if(!i)return;e.selectionEnd;d(e,"<br>",n-i[1].length,n)}static brToLR(t){const e=function(t){if(!t)return o(t);const e=c.exec(t);return e?e[0]+o(t.substring(e[0].length)):o(t)}(t.value);if(e===t.value)return;const n=t.selectionStart,r=t.selectionEnd||n,i=t.value;t.value=e;const s=t.value.length-i.length;null!==n&&null!==r&&t.setSelectionRange(n+s,r+s)}}const v={"&":"&amp;","'":"&#x27;",'"':"&quot;","`":"&#x60;","<":"&lt;",">":"&gt;"},f=new RegExp(`[${Object.keys(v).join("")}]`,"g");function m(t){return t.replace(f,t=>v[t])}const g=function t(e){const n=Object.getOwnPropertyNames(e);for(const r of n){const n=e[r];e[r]=n&&"object"==typeof n?t(n):n}return Object.freeze(e)}({F:{pattern:"F(?=\\d)",tagName:"span"},B:{pattern:"B",tagName:"b"},I:{pattern:"I",tagName:"i"},S:{pattern:"S",tagName:"s"},U:{pattern:"U",tagName:"u"}});let b=0;const S=[];for(const t in g)if(g.hasOwnProperty(t)){const e=g[t].pattern;b=e.length,S.push(e)}const w=b+1,F=S.join("|"),E="(?:"+F+")[1-7]?";function A(t,e,n,r){const i=g[e.toUpperCase()].tagName;return n?`<${i} class='F${n}'>${r}</${i}>`:`<${i}>${r}</${i}>`}const y=new RegExp(m("<"+("("+F+")([1-7]?)")+">(.*?)</\\1\\2>"),"ig");const T=new RegExp("<("+E+")>","gi"),x=new RegExp("</("+E+")>","gi"),C=new RegExp("<?("+E+")>?$","i"),N=new RegExp("</("+E+")>$","i"),B=new RegExp("</?([^>]{0,"+w+"}?)$"),I=new RegExp(E,"i");class _{constructor(){}enable(t,e){const n=this,r=function(t){n.autoCompleteTag(this,t)};return e?$(t).on("keydown",e,r):$(t).on("keydown",r),this}autoCompleteTag(t,e){if(9===e.keyCode){if(e.preventDefault(),t.selectionEnd&&t.selectionStart!==t.selectionEnd)return void t.setSelectionRange(t.selectionEnd,t.selectionEnd);if(this.insertOrnamentTags(t))return;this.insertLastUnclosedTagEnd(t)}else"/"===e.key&&this.completeLastUnclosedTagEnd(t)&&e.preventDefault()}insertOrnamentTags(t){if("number"!=typeof t.selectionStart)return!1;if(t.selectionEnd&&t.selectionStart!==t.selectionEnd)return!1;const e=t.selectionStart,n=t.value.slice(0,e),r=t.value.slice(e),i=C.exec(n);if(!i)return!1;if(N.test(n))return!1;if(/^<[^<>]+?>$/.test(i[0]))return!1;const s=B.exec(n);if(s){const t=new RegExp("^([^<]{0,"+(w-s[1].length)+"}?)>").exec(r);if(t){if(I.test(s[1]+t[1]))return!1}}d(t,"<"+i[1]+"></"+i[1]+">",e-i[0].length,e);const o=e-i[0].length+i[1].length+2;return t.setSelectionRange(o,o),!0}insertLastUnclosedTagEnd(t){if("number"!=typeof t.selectionStart)return!1;if(t.selectionEnd&&t.selectionStart!==t.selectionEnd)return!1;const e=t.selectionStart,n=t.value.slice(0,e),r=t.value.slice(e),i=this.findUnclosedTags(n,r);return 0!==i.length&&(d(t,"</"+i[i.length-1]+">",e,e),!0)}findUnclosedTags(t,e){const n=t.match(T);if(!n)return[];const r=n.map((t,e)=>t.slice(1,t.length-1)),i=(t+e).match(x);if(!i)return r;const s=i.map((t,e)=>t.slice(2,t.length-1));for(let t=s.length-1;t>=0;t--)for(let e=r.length-1;e>=0;e--)if(s[t]===r[e]){r.splice(e,1);break}return r}completeLastUnclosedTagEnd(t){if("number"!=typeof t.selectionStart)return!1;if(t.selectionStart<=0||t.selectionStart!==t.selectionEnd)return!1;const e=t.selectionStart,n=t.value.slice(0,e),r=t.value.slice(e);if("<"!==n[e-1])return!1;const i=this.findUnclosedTags(n,r);return 0!==i.length&&(d(t,"/"+i[i.length-1]+">",e,e),!0)}}class O{constructor(){}enable(t,e,n){let r="input[type='submit']";"string"==typeof n&&(r+="[value='"+n+"']");const i=this,s=function(t){const e=$(this).closest("form").find(r);i.submitWithCertainKeysDown(e,t)};return e?$(t).on("keydown",e,s):$(t).on("keydown",s),this}submitWithCertainKeysDown(t,e){13===e.keyCode&&e.ctrlKey&&e.shiftKey&&(e.preventDefault(),t.first().trigger("click"))}}class L{constructor(){this.submitted=!1}enable(t,e){const n=function(t){this.submitted&&t.preventDefault(),this.submitted=!0};e?$(t).on("submit",e,n):$(t).on("submit",n)}}function M(t,e,n){let r,i=void 0;n?(r=n,i=e):r=e;const s=function(t,...e){return"touchstart"===t.type&&t.preventDefault(),r.apply(this,[t,...e])};return t.on({click:s,ontouchstart:s},i)}var R=n(2),k=n.n(R);function D(t,e){let n=t.toString();for(const t in e)void 0!==e[t]&&null!==e[t]&&(n=n.replace(new RegExp("{"+t+"}","g"),e[t].toString()));return n}class P{constructor(t){this.attachedElement=null,this.$help=$(D(k.a,{SCRIPT_NAME:t}));const e=this;this.onClickHandler=function(t){t.preventDefault();const n=this;e.attachedElement===n?(e.$help.hide(),e.attachedElement=null):(e.$help.insertAfter(n).show(),e.attachedElement=n)}}enable(t,e){e?M($(t),e,this.onClickHandler):M($(t),this.onClickHandler),M(this.$help,()=>{this.$help.hide(),this.attachedElement=null})}}class U{constructor(){this.id=0,this.prevResolve=null}setDelay(t,e,...n){return new Promise((r,i)=>{this.id&&this.prevResolve&&(clearTimeout(this.id),this.prevResolve(null)),this.id=setTimeout(e=>{this.id=0,this.prevResolve=null,r(t.apply(null,e))},e,n),this.prevResolve=r})}static delay(t){return new Promise(e=>{setTimeout(()=>e(),t)})}}var H=n(3),V=n.n(H);class j{constructor(t){this.$preview=null,this.delayMS=t.delayMS,this.previewType=t.previewType,this.containerClass=t.containerClass,this.removePreviousPreview=t.removePreviousPreview,this.delayer=new U}buildDelayedEventCallback(t){const e=this.buildInstantEventCallback(t);return t=>{this.delayer.setDelay(()=>{e(t)},this.delayMS)}}buildInstantEventCallback(t){return e=>{this.insertPreview(t.targetSelector(e),t.type);const n=this.buildHtml(e);this.updatePreview(n)}}insertPreview(t,e){switch(e){case"insertBefore":this.$preview&&$(t).prev().is("."+j.PREVIEW_CONTAINER_CLASS_NAME)?this.$preview=$(t).prev():(this.$preview&&this.removePreviousPreview||(this.$preview=this.buildContainer()),this.$preview.insertBefore(t));break;case"insertAfter":this.$preview&&$(t).next().is("."+j.PREVIEW_CONTAINER_CLASS_NAME)?this.$preview=$(t).next():(this.$preview&&this.removePreviousPreview||(this.$preview=this.buildContainer()),this.$preview.insertAfter(t));break;case"prepend":this.$preview&&$(t).children().first().is("."+j.PREVIEW_CONTAINER_CLASS_NAME)?this.$preview=$(t).children().first():(this.$preview&&this.removePreviousPreview||(this.$preview=this.buildContainer()),this.$preview.prependTo(t));break;case"append":this.$preview&&$(t).children().last().is("."+j.PREVIEW_CONTAINER_CLASS_NAME)?this.$preview=$(t).children().last():(this.$preview&&this.removePreviousPreview||(this.$preview=this.buildContainer()),this.$preview.appendTo(t))}return this.$preview}updatePreview(t){this.$preview||this.throwNoPreviewContainerError(),this.$preview.find(".PreviewBody").html(t),t?this.$preview.show():this.$preview.hide()}showPreview(){this.$preview||this.throwNoPreviewContainerError(),this.$preview.show()}hidePreview(){this.$preview||this.throwNoPreviewContainerError(),this.$preview.hide()}buildContainer(){return this.$preview=$(`<div class="${j.PREVIEW_CONTAINER_CLASS_NAME}"/>`).html(D(V.a,{PREVIEW_TYPE:this.previewType})).addClass(this.containerClass),this.$preview}throwNoPreviewContainerError(){throw new Error("invalid operation: preview container have not inserted yet.")}}j.PREVIEW_CONTAINER_CLASS_NAME="PreviewContainer";const W=/[\u{0}-\u{9}\u{B}\u{C}\u{E}-\u{1F}\u{10000}-\u{10FFFF}]/gu;class z extends j{constructor(t){super(t),this.userENo=(/IBR_KEY=.+?_(\d+)(?:;|$)/.exec(document.cookie)||[])[1]||null}static sanitizeText(t){return function(t,e=""){return t.replace(W,e)}(function(t,e=""){return t?(t=(t=t.replace(a,"")).replace(l,""))||e:t}(t,"?"),"?")}}z.DEFAULT_ICON="p/nii.png";var K=n(4),X=n.n(K),G=n(5),Y=n.n(G),Q=n(6),q=n.n(Q);n(13);class Z extends z{constructor(t){super({delayMS:t,previewType:"発言",containerClass:"TalkPreview",removePreviousPreview:!0}),this.delayMS=t,this.maxChars=Z.DEFAULT_MAX_CHARS,this.maxNameChars=Z.DEFAULT_MAX_NAME_CHARS,this.iconUrls=Z.extractIconUrlArray()}enable(){const t=this.buildDelayedEventCallback({targetSelector:t=>$(t.currentTarget).closest("form")[0],type:"insertAfter"});return $(document.body).on("input","textarea[name^='dt_mes']",t).on("input","input[name^='dt_ai']",t).on("change","select[name^='dt_ic']",t),this}buildHtml(t,...e){const n=$(t.currentTarget).parent("form"),r={$text:n.find("textarea[name^='dt_mes']"),$name:n.find("input[name^='dt_ai']"),$icon:n.find("select[name^='dt_ic']")};return this.formatHtml(r)}formatHtml(t){const e=z.sanitizeText(t.$text.val());return 0===e.length?e:e.length>this.maxChars?D(q.a,{CHARS:e.length,MAX_CHARS:this.maxChars}):this.formatPreviewHtml(e,t)}formatPreviewHtml(t,e){let n="SE3",r="";const i=e.$name.closest("form");Z.isResponseForm(i)&&(n="SE4",r="<a class='F1' href='#'>＞返信 <br></a>");const o=z.sanitizeText(e.$name.val());if(o.length>this.maxNameChars)return D(Y.a,{CHARS:o.length,MAX_CHARS:this.maxNameChars});let a=m(o),l=t;const c=/^@([\s\S]*?)@/.exec(l);c&&(c[1]&&(a=s(m(c[1]))),l=l.substring(c[0].length)),l=function(t){let e=m(t);e=s(e).replace(/&lt;br&gt;/gi,"<BR>");for(let t=0;t<2;t++)e=e.replace(/&lt;(([1-9][0-9]?)D([1-9][0-9]?[0-9]?))&gt;/i,"<span class='DX'>【 <b>$1</b>：[$2個の$3面ダイスを振る] 】</span>");return function(t,e,n){let r=t.toString();for(;;){if(!e.test(r))return r;r=r.replace(e,n)}}(e,y,A)}(l);const h=e.$icon.val();let d=z.DEFAULT_ICON;return/^\d+$/.test(h)&&(d=this.iconUrls[parseInt(h,10)]),D(X.a,{CNT_CLASS_NAME:n,RESPONSE:r,ICON_URL:d,SENDER_NAME:a,SENDER_ENO:this.userENo,TALK_HTML:l})}static isResponseForm(t){return"say"!==t.attr("name")}static extractIconUrlArray(){return $("#CL1 img.IC").get().map(t=>{var e;return null!=(e=t.getAttribute("src"))?e:""})}}Z.DEFAULT_MAX_CHARS=400,Z.DEFAULT_MAX_NAME_CHARS=8;n(16);class J{constructor(){}enable(){const t=$("#PLSBN3").parent("a"),e=t.prop("onclick"),n=this;this.eventCallback=function(t){e.call(this,t),n.switchColumnClass(this)},M(t.prop("onclick",""),this.eventCallback),this.switchColumnClass(t[0])}switchColumnClass(t){2===(-1===t.textContent.indexOf("２列")?2:1)?$("div.MXM").addClass(J.CLASSNAME_TWO_COLUMNS).removeClass(J.CLASSNAME_ONE_COLUMN):$("div.MXM").addClass(J.CLASSNAME_ONE_COLUMN).removeClass(J.CLASSNAME_TWO_COLUMNS)}}J.CLASSNAME_ONE_COLUMN="OneColumn",J.CLASSNAME_TWO_COLUMNS="TwoColumns";var tt="IbaraTalkUtil",et=2,nt=function(t,e,n,r){return new(n||(n=Promise))((function(i,s){function o(t){try{l(r.next(t))}catch(t){s(t)}}function a(t){try{l(r.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}l((r=r.apply(t,e||[])).next())}))};class rt{constructor(t){this.db=null,this.dbName=t.dbName,this.tableName=t.tableName,this.dbVersion=t.dbVersion,t.optionalParameters&&(this.optionalParameters=Object.freeze(Object.assign({},t.optionalParameters)))}get DBPromise(){return this.dbPromise}get DBIsOpen(){return!!this.db}open(t){const e=indexedDB.open(this.dbName,this.dbVersion);return this.dbPromise=new Promise((n,r)=>{const i=this;e.onsuccess=function(t){i.db=this.result,n(i.db)},e.onerror=function(t){i.db=null,r("db error")},e.onupgradeneeded=function(e){const n=this.result;if(n.objectStoreNames.contains(i.tableName))t&&t(n,e);else{n.createObjectStore(i.tableName,i.optionalParameters)}}})}close(){var t;null===(t=this.db)||void 0===t||t.close()}count(t){if(!this.db)throw this.throwDBIsNotReadyError();const e=this.db.transaction(this.tableName,"readonly").objectStore(this.tableName).count(t);return new Promise((t,n)=>{e.onsuccess=function(e){t(this.result)},e.onerror=function(t){n("db error")}})}get(t){if(!this.db)throw this.throwDBIsNotReadyError();const e=this.db.transaction(this.tableName,"readonly").objectStore(this.tableName).get(t);return new Promise((t,n)=>{e.onsuccess=function(e){t(this.result)},e.onerror=function(t){n("db error")}})}getAll(t,e){if(!this.db)throw this.throwDBIsNotReadyError();const n=this.db.transaction(this.tableName,"readonly").objectStore(this.tableName).getAll(t,e);return new Promise((t,e)=>{n.onsuccess=function(e){t(this.result)},n.onerror=function(t){e("db error")}})}getAllDescending(t,e){return nt(this,void 0,void 0,(function*(){const n=[];if(void 0===e)return yield this.iterate(t=>(n.push(t),!1),t,"prev"),n;let r=e;return r<=0?n:(yield this.iterate(t=>(n.push(t),0==--r),t,"prev"),n)}))}getKey(t){if(!this.db)throw this.throwDBIsNotReadyError();const e=this.db.transaction(this.tableName,"readonly").objectStore(this.tableName).getKey(t);return new Promise((t,n)=>{e.onsuccess=function(e){t(this.result)},e.onerror=function(t){n("db error")}})}getAllKeys(t,e){if(!this.db)throw this.throwDBIsNotReadyError();const n=this.db.transaction(this.tableName,"readonly").objectStore(this.tableName).getAllKeys(t,e);return new Promise((t,e)=>{n.onsuccess=function(e){t(this.result)},n.onerror=function(t){e("db error")}})}add(t,e){if(!this.db)throw this.throwDBIsNotReadyError();const n=this.db.transaction(this.tableName,"readwrite").objectStore(this.tableName);return this._add(n,t,e)}bulkAdd(t){if(!this.db)throw this.throwDBIsNotReadyError();const e=this.db.transaction(this.tableName,"readwrite").objectStore(this.tableName);return this._addMany(e,t)}put(t,e){if(!this.db)throw this.throwDBIsNotReadyError();const n=this.db.transaction(this.tableName,"readwrite").objectStore(this.tableName);return this._put(n,t,e)}bulkPut(t){if(!this.db)throw this.throwDBIsNotReadyError();const e=this.db.transaction(this.tableName,"readwrite").objectStore(this.tableName);return this._putMany(e,t)}delete(t){if(!this.db)throw this.throwDBIsNotReadyError();const e=this.db.transaction(this.tableName,"readwrite").objectStore(this.tableName);return this._delete(e,t)}bulkDelete(t){if(!this.db)throw this.throwDBIsNotReadyError();const e=this.db.transaction(this.tableName,"readwrite").objectStore(this.tableName);return this._deleteMany(e,t)}clear(){if(!this.db)throw this.throwDBIsNotReadyError();const t=this.db.transaction(this.tableName,"readwrite").objectStore(this.tableName);return this._clear(t)}replaceAll(t){return nt(this,void 0,void 0,(function*(){if(!this.db)throw this.throwDBIsNotReadyError();const e=this.db.transaction(this.tableName,"readwrite").objectStore(this.tableName);return yield this._clear(e),yield this._addMany(e,t)}))}openCursor(t,e,n){if(!this.db)throw this.throwDBIsNotReadyError();return this.db.transaction(this.tableName,n).objectStore(this.tableName).openCursor(t,e)}openKeyCursor(t,e,n){if(!this.db)throw this.throwDBIsNotReadyError();return this.db.transaction(this.tableName,n).objectStore(this.tableName).openKeyCursor(t,e)}iterate(t,e,n,r){const i=this.openCursor(e,n,r);return new Promise((e,n)=>{i.onsuccess=function(n){const r=this.result;r?t(r.value,r)?e():r.continue():e()},i.onerror=function(t){n("db error")}})}iterateKey(t,e,n,r){const i=this.openKeyCursor(e,n,r);return new Promise((e,n)=>{i.onsuccess=function(n){const r=this.result;r?t(r.key,r)?e():r.continue():e()},i.onerror=function(t){n("db error")}})}_clear(t){const e=t.clear();return new Promise((t,n)=>{e.onsuccess=function(e){t()},e.onerror=function(t){n("db error")}})}_add(t,e,n){const r=t.add(e,n);return new Promise((t,e)=>{r.onsuccess=function(e){t(this.result)},r.onerror=function(t){e("db error")}})}_addMany(t,e){return nt(this,void 0,void 0,(function*(){if(0===e.length)return[];const n=[];for(const r of e)n.push(yield this._add(t,r));return n}))}_put(t,e,n){const r=t.put(e,n);return new Promise((t,e)=>{r.onsuccess=function(e){t(this.result)},r.onerror=function(t){e("db error")}})}_putMany(t,e){return nt(this,void 0,void 0,(function*(){if(0===e.length)return[];const n=[];for(const r of e)n.push(yield this._put(t,r));return n}))}_delete(t,e){if(!this.db)throw this.throwDBIsNotReadyError();const n=t.delete(e);return new Promise((t,e)=>{n.onsuccess=function(e){t()},n.onerror=function(t){e("db error")}})}_deleteMany(t,e){return nt(this,void 0,void 0,(function*(){if(0!==e.length)for(const n of e)yield this._delete(t,n)}))}throwDBIsNotReadyError(){throw new Error("DBの準備が完了していません。Promiseを参照してDBが開けるまで待機してください。")}}const it=/^(\d+)$/,st=/\s?eno\s*:\s*(\d+)/,ot=/\s?place\s*:\s*(\d+)/,at=/\s?tree\s*:\s*(\d+)/;class lt{constructor(t){this.id=t.id,this.treeId=t.treeId,this.eno=t.eno,this.resNames=t.resNames,this.name=t.name,this.iconUrl=t.iconUrl,this.placeId=t.placeId,this.placeName=t.placeName,this.date=t.date,this.bodyHtml=t.bodyHtml,this.trueId=lt.toTrueId(this.id)}static toTrueId(t){return t%1e3*1e7+Math.floor(t/1e3)}static toId(t){return t%1e7*1e3+Math.floor(t/1e7)}static matchFavItem(t,e){if(!t)return!0;const n=it.exec(t)||st.exec(t);if(n){const r=n[1];if(!(parseInt(r,10)===e.eno||!!e.resNames&&-1!==e.resNames.indexOf(`(${r})`)))return!1;t=t.split(n[0]).join("")}const r=ot.exec(t);if(r){const n=r[1];if(!(parseInt(n,10)===e.placeId))return!1;t=t.split(r[0]).join("")}const i=at.exec(t);if(i){const n=i[1],r=parseInt(n,10);if(!(r===e.treeId||r===e.id))return!1;t=t.split(i[0]).join("")}const s=t.trim().toLowerCase();return-1!==e.name.toLowerCase().indexOf(s)||!!e.resNames&&-1!==e.resNames.indexOf(t)||-1!==e.placeName.toLowerCase().indexOf(s)||-1!==e.bodyHtml.toLowerCase().indexOf(s)}static getFavSearchQueryString(t){const e=[];return t.word&&e.push(t.word),"number"==typeof t.eno&&e.push("eno:"+t.eno),"number"==typeof t.placeId&&e.push("place:"+t.placeId),"number"==typeof t.treeId&&e.push("tree:"+t.treeId),e.join(" ")}static isSane(t){let e=null;return e="number"==typeof t.id?e:"id",e="number"==typeof t.eno?e:"eno",e="number"==typeof t.treeId?e:"treeId",e="number"==typeof t.placeId?e:"placeId",e=void 0!==t.resNames?e:"resNames",e=t.name||""===t.name?e:"name",e=t.iconUrl||""===t.iconUrl?e:"iconUrl",e=t.placeName||""===t.placeName?e:"placeName",e=t.date||""===t.date?e:"date",e=t.bodyHtml||""===t.bodyHtml?e:"bodyHtml",!e}}var ct=function(t,e,n,r){return new(n||(n=Promise))((function(i,s){function o(t){try{l(r.next(t))}catch(t){s(t)}}function a(t){try{l(r.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}l((r=r.apply(t,e||[])).next())}))};class ht{constructor(){this.table=new rt({dbName:tt,dbVersion:et,tableName:"FavData",optionalParameters:{autoIncrement:!1,keyPath:"trueId"}}),this.table.dbVersion>=1&&this.table.open()}get DBPromise(){return new Promise((t,e)=>{this.table.DBPromise.then(()=>t(),t=>e(t))})}get DBIsOpen(){return this.table.DBIsOpen}put(t){return this.table.put(t)}delete(t){return this.table.delete(lt.toTrueId(t))}count(){return this.table.count()}getAll(){return this.table.getAll()}bulkAdd(t){return this.table.bulkAdd(t)}bulkPut(t){return this.table.bulkPut(t)}bulkDelete(t){return this.table.bulkDelete(t.map(lt.toTrueId))}clear(){return this.table.clear()}replaceAll(t){return this.table.replaceAll(t)}contains(t){return ct(this,void 0,void 0,(function*(){let e=!1;const n=lt.toTrueId(t);return yield this.table.iterateKey(t=>(e=!0,!0),n,"prev"),e}))}intersect(t){return ct(this,void 0,void 0,(function*(){if(0===t.length)return[];const e=t.map(lt.toTrueId).sort((t,e)=>e-t);let n=e.shift();const r=[];return yield this.table.iterateKey(t=>{for(;n>=t;){if(n===t&&r.push(lt.toId(n)),0===e.length)return!0;n=e.shift()}return!1},null,"prev"),r}))}search(t,e=null,n,r,i){return ct(this,void 0,void 0,(function*(){const s=[];let o=null;if("number"==typeof e&&(o=i&&i.startsWith("prev")?IDBKeyRange.upperBound(lt.toTrueId(e),!!n):i&&i.startsWith("next")?IDBKeyRange.lowerBound(lt.toTrueId(e),!!n):e),"number"!=typeof r)yield this.table.iterate(e=>{lt.matchFavItem(t,e)&&s.push(e)},o,i);else{if(r<=0)return[];let e=r;yield this.table.iterate(n=>{if(lt.matchFavItem(t,n)&&(s.push(n),0==--e))return!0},o,i)}return s}))}}var dt=function(t,e,n,r){return new(n||(n=Promise))((function(i,s){function o(t){try{l(r.next(t))}catch(t){s(t)}}function a(t){try{l(r.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}l((r=r.apply(t,e||[])).next())}))};var ut=function(t,e,n,r){return new(n||(n=Promise))((function(i,s){function o(t){try{l(r.next(t))}catch(t){s(t)}}function a(t){try{l(r.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}l((r=r.apply(t,e||[])).next())}))};var pt=function(t,e,n,r){return new(n||(n=Promise))((function(i,s){function o(t){try{l(r.next(t))}catch(t){s(t)}}function a(t){try{l(r.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}l((r=r.apply(t,e||[])).next())}))};class vt extends class extends class{constructor(t="text/plain"){this.mime=t,this.$dlAnchor=$("<a></a>").css("display","none").appendTo(document.body),this.onExport=null,this.$dlInput=this.initDlInput()}enable(t,e){M($(t),()=>this.export()),M($(e),()=>this.$dlInput.click())}initDlInput(){const t=this;return $("<input type='file'>").attr("accept",this.mime).css("display","none").appendTo(document.body).on("change",(function(){return dt(this,void 0,void 0,(function*(){const e=this.files;e&&0!==e.length&&(yield t.import(e[0]),this.value="")}))}))}export(){return dt(this,void 0,void 0,(function*(){if(this.onExport&&(yield this.onExport()))return;const t=yield this.buildContentToExport(),e=this.buildFileName(t),n=new Blob([t],{type:this.mime}),r=new File([n],e),i=this.$dlAnchor[0];i.href=URL.createObjectURL(r),i.download=e,i.click()}))}import(t){return dt(this,void 0,void 0,(function*(){const e=yield this.selectContent(yield new Response(t));yield this.afterImported(e)}))}}{constructor(t,e){super("application/json"),this.jsonReplacer=t,this.jsonSpace=e}buildContentToExport(){return ut(this,void 0,void 0,(function*(){const t=yield this.selectObject();return this.nextFileName=this.buildJSONFileName(t),JSON.stringify(t,this.jsonReplacer,this.jsonSpace)}))}buildFileName(t){return this.nextFileName}selectContent(t){return ut(this,void 0,void 0,(function*(){return yield t.text()}))}afterImported(t){this.afterImportedObject(JSON.parse(t))}}{constructor(t){super(),this.db=t,this.messenger=alert,this.afterImportedFavs=null,this.afterImportedObject=t=>this.validateThenStoreFavs(t)}selectObject(){return pt(this,void 0,void 0,(function*(){return yield this.db.getAll()}))}buildJSONFileName(t){const e=(n=new Date(Date.now())).getFullYear().toString().slice(-2)+("0"+n.getDate()).slice(-2)+("0"+n.getHours()).slice(-2)+("0"+n.getMinutes()).slice(-2)+("0"+n.getSeconds()).slice(-2);var n;return vt.FILE_NAME_PREFIX+e+vt.FILE_NAME_SUFFIX}afterImportedObject(t){return this.validateThenStoreFavs(t)}validateThenStoreFavs(t){return pt(this,void 0,void 0,(function*(){const e=[];for(const n of t)if(lt.isSane(n)){const t=n;t.trueId=lt.toTrueId(n.id),e.push(t)}else this.throwInvalidFileImportedError("insane item: "+JSON.stringify(n));let n;0===(yield this.db.count())?(n=yield this.db.bulkAdd(e),this.messenger("入力完了！")):(n=yield this.db.bulkPut(e),this.messenger("追加完了！")),this.afterImportedFavs&&(yield this.afterImportedFavs(n))}))}throwInvalidFileImportedError(t){throw alert("お気に入り情報の復元に失敗しました。入力されたファイルの形式が不正です。"),new Error("InvalidFileImportedError\ninfo: "+t)}}vt.FILE_NAME_PREFIX=tt+"_FavData",vt.FILE_NAME_SUFFIX=".json";var ft=n(7),mt=n.n(ft),gt=n(8),bt=n.n(gt),St=n(9),wt=n.n(St),Ft=n(10),Et=n.n(Ft),At=(n(18),n(20),function(t,e,n,r){return new(n||(n=Promise))((function(i,s){function o(t){try{l(r.next(t))}catch(t){s(t)}}function a(t){try{l(r.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}l((r=r.apply(t,e||[])).next())}))});class yt{constructor(){this.searchDelayer=new U,this.bigButtonDelayer=new U,this.searchingPromise=null,this.currentFavItems=null,this.maxShownFavsCount=yt.initialShownFavsCount,this.$frame=null,this.$regularLineElements=$("#LEFTLINE,#RIGHTLINE,form[name='nex'],form[name='bef']"),this.$showFavsBtn=$(`<span class="${yt.CLASSNAME_SHOW_FAVS_BUTTON}">お気に入り</span>`),this.$favTimeLineOrdering=null,this.db=new ht,this.io=new vt(this.db),this.io.messenger=yt.showControlMessage}enable(t){return At(this,void 0,void 0,(function*(){yield this.db.DBPromise,yield this.addFavButtons(t);const e=this;M($(t),"."+yt.CLASSNAME_FAV_BUTTON,(function(t){e.toggleFav(this)})),this.$showFavsBtn.insertAfter($(".BUTT3 > img").parent().parent("a").next("a").next("a")),M(this.$showFavsBtn,()=>this.toggleFavTimeLine()),this.insertBigFavButtons()}))}insertBigFavButtons(){const t=$(Et.a).appendTo(document.body);$(window).on("keydown",e=>{e.target===document.body&&e.shiftKey&&16===e.keyCode&&(t.toggleClass(yt.CLASSNAME_SHOWN),this.bigButtonDelayer.setDelay(()=>{t.removeClass(yt.CLASSNAME_SHOWN)},yt.bigButtonTimeoutMS))}),M(t.filter(".FavChatAll"),e=>At(this,void 0,void 0,(function*(){e.preventDefault(),yield this.addAllFavOfVisible(),t.removeClass(yt.CLASSNAME_SHOWN)}))),M(t.filter(".RmFavChatAll"),e=>At(this,void 0,void 0,(function*(){e.preventDefault(),yield this.removeAllFavOfVisible(),t.removeClass(yt.CLASSNAME_SHOWN)})))}toggleFav(t){return At(this,void 0,void 0,(function*(){t.classList.contains(yt.CLASSNAME_FAV_BUTTON_FAVD)?yield this.removeFav(t):yield this.addFav(t)}))}addFav(t){const e=this.extractIdFromFavButton(t);this.activateFavButtonsOnChat(e),t.classList.add(yt.CLASSNAME_FAV_BUTTON_FAVD);const n=this.takeOrBuildFavItem(t);return this.db.put(n)}removeFav(t){const e=this.extractIdFromFavButton(t);return this.deactivateFavButtonsOnChat(e),t.classList.remove(yt.CLASSNAME_FAV_BUTTON_FAVD),this.db.delete(e)}addAllFavOfVisible(){const t=this.$queryAllVisibleFavButtons("non-favd").get(),e=[];for(const n of t){const t=this.extractIdFromFavButton(n);this.activateFavButtonsOnChat(t),n.classList.add(yt.CLASSNAME_FAV_BUTTON_FAVD),e.push(this.takeOrBuildFavItem(n))}return 0===e.length?Promise.resolve([]):this.db.bulkPut(e)}removeAllFavOfVisible(){const t=this.$queryAllVisibleFavButtons("favd").get().map(t=>{const e=this.extractIdFromFavButton(t);return this.deactivateFavButtonsOnChat(e),t.classList.remove(yt.CLASSNAME_FAV_BUTTON_FAVD),e});return 0===t.length?Promise.resolve():this.db.bulkDelete(t)}$findFavButtonsOnChatWithTheSameId(t){if(!this.$frame||!this.favTimeLineIsVisible())return null;let e;e="number"==typeof t?[t]:t;const n=this;return this.$regularLineElements.find("."+yt.CLASSNAME_FAV_BUTTON).filter((function(){const t=n.extractIdFromFavButton(this);return-1!==e.findIndex(e=>e===t)}))}activateFavButtonsOnChat(t){let e;e=void 0===t?$("."+yt.CLASSNAME_FAV_BUTTON):this.$findFavButtonsOnChatWithTheSameId(t),e&&e.addClass(yt.CLASSNAME_FAV_BUTTON_FAVD)}deactivateFavButtonsOnChat(t){let e;e=void 0===t?$("."+yt.CLASSNAME_FAV_BUTTON):this.$findFavButtonsOnChatWithTheSameId(t),e&&e.removeClass(yt.CLASSNAME_FAV_BUTTON_FAVD)}addFavButtons(t,e=!1){return At(this,void 0,void 0,(function*(){const n=$(t).find("a.RE"),r=n.get().map(t=>{var e;return parseInt(null!=(e=t.getAttribute("nn"))?e:t.dataset.nn,10)});let i=null;return e||(i=new Set(yield this.db.intersect(r))),n.each((t,n)=>{const s=$(`<span class="${yt.CLASSNAME_FAV_BUTTON}"></span>`).insertBefore(n);s[0].dataset[yt.DATANAME_FAV_BUTTON_ID]=r[t].toString(),(e||i.has(r[t]))&&s.addClass(yt.CLASSNAME_FAV_BUTTON_FAVD)}).prev()}))}extractIdFromFavButton(t){if("string"!=typeof t.dataset[yt.DATANAME_FAV_BUTTON_ID])throw new Error("invalid operation");return parseInt(t.dataset[yt.DATANAME_FAV_BUTTON_ID],10)}takeOrBuildFavItem(t){const e=this.extractIdFromFavButton(t);if(this.currentFavItems){const t=this.currentFavItems.find(t=>t.id===e);if(t)return t}return this._buildFavItem(t)}_buildFavItem(t){const e=this.extractIdFromFavButton(t);let n;const r=t.parentElement.childNodes[1],i=t.parentElement.childNodes[2],s=t.parentElement.childNodes[3];n=3===r.nodeType&&" "===r.textContent&&1===i.nodeType&&"br"===i.tagName.toLowerCase()?s:r;const o=/\((.+?)\)/.exec(n.textContent),a=o?o[1]:"",l=t.parentElement.firstElementChild.textContent.substring(3),c=$(t).closest("table").find("tr:first"),h=c.find("td:first>img")[0],d=parseInt(h.getAttribute("snn"),10),u=parseInt(h.getAttribute("no"),10),p=parseInt(h.getAttribute("pl"),10),v=h.getAttribute("src"),f=c.find("td:eq(1)").clone(),m=f.contents();let g,b=null;m.eq(0).is("a.F1")?(b=m.eq(0).text().slice(1,-1),m.eq(0).remove(),g=m.eq(1)):g=m.eq(0);const S=g.text().slice(0,-(u.toString().length+2));g.remove(),f.children().first().remove();const w=f.html();return f.remove(),new lt({id:e,treeId:d,eno:u,placeId:p,placeName:l,date:a,iconUrl:v,resNames:b,name:S,bodyHtml:w})}$queryAllVisibleFavButtons(t="all"){let e;return e=this.favTimeLineIsVisible()?this.$frame.find("."+yt.CLASSNAME_FAV_BUTTON):this.$regularLineElements.find("."+yt.CLASSNAME_FAV_BUTTON),"favd"===t?e=e.filter("."+yt.CLASSNAME_FAV_BUTTON_FAVD):"non-favd"===t&&(e=e.not("."+yt.CLASSNAME_FAV_BUTTON_FAVD)),e}favTimeLineIsVisible(){return!!this.$frame&&"none"!==this.$frame.css("display")}toggleFavTimeLine(){return At(this,void 0,void 0,(function*(){if(this.favTimeLineIsVisible())return this.$showFavsBtn.removeClass(yt.CLASSNAME_SHOWN),this.$frame.fadeOut(yt.animationFadeMS),this.$regularLineElements.fadeIn(yt.animationFadeMS),void(this.currentFavItems=null);this.maxShownFavsCount<=0||(this.$frame||(this.$frame=this.initFavTimeLine().hide(),this.$frame.insertBefore("#LEFTLINE")),(yield this.showFirstTimeLine())&&(this.$showFavsBtn.addClass(yt.CLASSNAME_SHOWN),this.$frame.show(),this.$regularLineElements.fadeOut(yt.animationFadeMS)))}))}initFavTimeLine(){const t=$(wt.a);this.$favTimeLineOrdering=t.find("#FavSearch > select").val(this.checkIfOrderingIsAscending()?"1":"0"),this.$frame=t;return M(t.find("#FavLinePrev").html(`前の${this.maxShownFavsCount}件を表示`),()=>At(this,void 0,void 0,(function*(){yield this.showPrevTimeLine()}))),M(t.find("#FavLineNext").html(`次の${this.maxShownFavsCount}件を表示`),()=>At(this,void 0,void 0,(function*(){yield this.showNextTimeLine()}))),this.enableSearch(),this.io.enable(t.find("#ExportFavs")[0],t.find("#ImportFavs")[0]),this.io.afterImportedFavs=t=>At(this,void 0,void 0,(function*(){const e=t.map(t=>lt.toId(t));this.deactivateFavButtonsOnChat(),this.activateFavButtonsOnChat(e),yield this.showFirstTimeLine()})),M(t.find("#DeleteFavs"),()=>this.deleteFavs()),t}showFirstTimeLine(){return At(this,void 0,void 0,(function*(){const t=yield this._searchFirst();return!!t&&(yield this.overwriteFavItemsOnFavTimeLine(t),!0)}))}showNextTimeLine(){return At(this,void 0,void 0,(function*(){if(!this.currentFavItems)throw new Error("invalid operation");if(this.currentFavItems.length<this.maxShownFavsCount)return!1;const t=yield this._searchNext();return!(!t||0===t.length)&&(yield this.overwriteFavItemsOnFavTimeLine(t),!0)}))}showPrevTimeLine(){return At(this,void 0,void 0,(function*(){if(!this.currentFavItems)throw new Error("invalid operation");if(0===this.currentFavItems.length)return!1;let t=yield this._searchPrev();if(!t||0===t.length)return!1;if(t.length<this.maxShownFavsCount){const e=this.currentFavItems.slice().sort((t,e)=>t.trueId-e.trueId);let n;n=this.checkIfOrderingIsAscending()?e.slice(0,this.maxShownFavsCount-t.length):e.reverse().slice(0,this.maxShownFavsCount-t.length),t=t.concat(n)}return yield this.overwriteFavItemsOnFavTimeLine(t),!0}))}overwriteFavItemsOnFavTimeLine(t){return At(this,void 0,void 0,(function*(){if(!this.$frame)throw new Error("invalid operation");this.currentFavItems=t;const e=t.map(this.formatFav),n=Math.ceil(this.maxShownFavsCount/2),r=[$(document.createDocumentFragment()),$(document.createDocumentFragment())];for(let t=0;t<e.length;++t)t<n?r[0].append(e[t]):r[1].append(e[t]);const i=this.$frame.find("#FavLeftLine"),s=this.$frame.find("#FavRightLine"),o=i.children(),a=s.children(),l=this.$frame.find("#FavLineBody");yield new Promise(t=>{l.fadeOut(yt.animationFadeMS/2,()=>{i.prepend(r[0]),s.prepend(r[1]),o.remove(),a.remove(),t()})}),l.fadeIn(yt.animationFadeMS/2),yield this.addFavButtons(this.$frame[0],!0)}))}enableSearch(){return At(this,void 0,void 0,(function*(){if(!this.$frame||!this.$favTimeLineOrdering)throw new Error("invalid operation");const t=this.$frame.find("#FavSearch > input");t.on("focus",(function(){this.setSelectionRange(0,this.value.length)})),t.on("input",t=>At(this,void 0,void 0,(function*(){13===t.keyCode?(t.preventDefault(),yield this.showFirstTimeLine()):this.searchDelayer.setDelay(()=>At(this,void 0,void 0,(function*(){yield this.showFirstTimeLine()})),yt.searchDelayMS)}))),this.$favTimeLineOrdering.on("change",()=>At(this,void 0,void 0,(function*(){yield this.showFirstTimeLine()}))),this.enableAdvancedSearchButton(t)}))}enableAdvancedSearchButton(t){if(!this.$frame)throw new Error("invalid operation");const e=this;M(this.$frame,".FavSearchOption",(function(n){if(!e.currentFavItems)throw new Error("invalid operation");const r=t[0],i=$(this).closest(".FavSearchBtn").siblings("."+yt.CLASSNAME_FAV_BUTTON)[0];if(!i)throw new Error("invalid operation");const s=e.extractIdFromFavButton(i),o=e.currentFavItems.find(t=>t.id===s);if(!o)throw new Error("invalid operation");const a={};r.value&&(a.word=r.value),this.classList.contains("OptionPlace")?a.placeId=o.placeId:this.classList.contains("OptionTree")?a.treeId=0===o.treeId?o.id:o.treeId:this.classList.contains("OptionENo")&&(a.eno=o.eno),r.value=lt.getFavSearchQueryString(a),t.trigger("input")}))}_search(t,e,n,r){return At(this,void 0,void 0,(function*(){if(!this.$frame)throw new Error("invalid operation");const i=this.searchingPromise;return this.searchingPromise=(()=>At(this,void 0,void 0,(function*(){const s=this.getSearchWordValue();if(i&&(yield i),this.getSearchWordValue()!==s)return null;const o=yield this.db.search(s,t,e,n,r);return this.searchingPromise=null,o})))()}))}_searchNext(){return At(this,void 0,void 0,(function*(){if(!this.currentFavItems)throw new Error("invalid operation");if(this.currentFavItems.length<this.maxShownFavsCount)return null;const t=this.currentFavItems.map(t=>t.trueId);let e;return e=this.checkIfOrderingIsAscending()?yield this._search(lt.toId(Math.max(...t)),!0,this.maxShownFavsCount,"next"):yield this._search(lt.toId(Math.min(...t)),!0,this.maxShownFavsCount,"prev"),e}))}_searchPrev(){return At(this,void 0,void 0,(function*(){if(!this.currentFavItems)throw new Error("invalid operation");if(0===this.currentFavItems.length)return null;const t=this.currentFavItems.map(t=>t.trueId);let e;return e=this.checkIfOrderingIsAscending()?yield this._search(lt.toId(Math.min(...t)),!0,this.maxShownFavsCount,"prev"):yield this._search(lt.toId(Math.max(...t)),!0,this.maxShownFavsCount,"next"),null===e?null:e.reverse()}))}_searchFirst(){return At(this,void 0,void 0,(function*(){let t;return t=this.checkIfOrderingIsAscending()?yield this._search(null,null,this.maxShownFavsCount,"next"):yield this._search(null,null,this.maxShownFavsCount,"prev"),t}))}getSearchWordValue(){return this.$frame&&"none"!==this.$frame.css("display")?this.$frame.find("#FavSearch > input").val():""}checkIfOrderingIsAscending(){return this.$frame?"1"===this.$frame.find("#FavSearch > select").val():yt.initiallyOrderedByAscending}deleteFavs(){return At(this,void 0,void 0,(function*(){confirm("お気に入り発言データをすべて消去してもよろしいですか？")&&(yield this.db.clear(),yt.showControlMessage("消去完了。"),this.deactivateFavButtonsOnChat(),yield this.showFirstTimeLine())}))}formatFav(t){let e,n;t.resNames?(e="SE4",n=mt.a):(e="SE3",n="");const r=D(bt.a,{RES_HTML:n});return D(r,{CLASS_NAME:e,ID:t.id,TREE_ID:t.treeId,PLACE_NAME:t.placeName,BR_IF_PLACENAME_LONG:t.placeName.length>=10?"<br>":"",NAME:t.name,ENO:t.eno,PLACE_ID:t.placeId,ICON_URL:t.iconUrl,DATE:t.date,RES_NAMES:t.resNames,BODY_HTML:t.bodyHtml,TREE_ID_OR_ID:0===t.treeId?t.id:t.treeId})}static selectFrame(){const t=$("#FavLine");return 0===t.length?null:t}static showControlMessage(t){const e=yt.selectFrame();if(!e)throw new Error("invalid operation");const n=e.find("#FavControlMessage").text(null!=t?t:"").hide();return new Promise(t=>{n.fadeIn(yt.animationFadeMS,()=>At(this,void 0,void 0,(function*(){yield U.delay(yt.messageDurationMS),n.fadeOut(yt.animationFadeMS,()=>{t()})})))})}}yt.CLASSNAME_FAV_BUTTON="FavChat",yt.CLASSNAME_FAV_BUTTON_FAVD="Favd",yt.CLASSNAME_SHOW_FAVS_BUTTON="ShowFavsBtn",yt.CLASSNAME_SHOWN="Shown",yt.DEFAULT_SHOWN_FAVS=10,yt.animationFadeMS=200,yt.searchDelayMS=200,yt.messageDurationMS=2e3,yt.bigButtonTimeoutMS=5e3,yt.initialShownFavsCount=parseInt($("input[name='dt_kz']").attr("value")||yt.DEFAULT_SHOWN_FAVS.toString(),10),yt.initiallyOrderedByAscending="1"===$("select[name='dt_jn'] > option").filter((function(){return!!$(this).attr("selected")})).val(),yt.DATANAME_FAV_BUTTON_ID="id";var Tt=n(11),xt=n.n(Tt);class Ct{constructor(t,e){if("number"==typeof t)this.start=t,this.end=e;else{const e=t;if(null===e.selectionStart||null===e.selectionEnd)throw new Error("invalid operation: selection start or end is null.");this.start=e.selectionStart,this.end=e.selectionEnd}}offset(t,e){return new Ct(this.start+t,this.end+(null!=e?e:t))}select(t,e=0,n=0){t.setSelectionRange(this.start+e,this.end+n)}insertText(t,e){return d(t,e,this.start,this.end),Ct.build(t)}insertBackspace(t){let e,n;return this.start===this.end?(e=Math.max(this.start-1,0),n=this.start):(e=this.start,n=this.end),d(t,"",e,n),Ct.build(t)}static build(t){return null===t.selectionStart||null===t.selectionEnd?null:new Ct(t)}}n(22);class Nt{constructor(){this.$helper=this.$initTagHelper(),this.sElem=null,this.storedSelection=null,this.tagEndSelection=null,this.outerTagSelection=null,this.hidingTimeoutId=0,this.hidingTimeoutMS=200}enable(t,e){const n=t=>{const e=t.currentTarget;e===this.sElem&&this.storedSelection&&this.storedSelection.start===e.selectionStart&&this.storedSelection.end===e.selectionEnd||(this.clearTagInsertedCondition(),this.setCurrentSelection(e)),this.show()};return M($(t),e,n).on({blur:t=>{this.setCurrentSelection(t.currentTarget),this.setHidingHelperTimeout()},mouseenter:t=>{this.sElem===t.currentTarget&&this.show()},mouseleave:t=>{this.sElem===t.currentTarget&&this.setHidingHelperTimeout()},keydown:t=>{this.storedSelection&&this.tagEndSelection&&(t.ctrlKey||t.altKey||!(8===t.keyCode||9===t.keyCode||t.keyCode>=48&&t.keyCode<=57||t.keyCode>=65&&t.keyCode<=90||t.keyCode>=97&&t.keyCode<=122)||(t.preventDefault(),8===t.keyCode?this.backspaceOnTag():9===t.keyCode?this.selectOuterTagEnd():this.insertCharOnTag(t.key)))},keyup:n},e),this}show(){if(!this.sElem)return;this.clearHidingHelperTimeout();const t=$(this.sElem).offset();this.$helper.css({left:t.left,top:t.top-this.$helper.height()}).show()}hide(){this.$helper.hide()}setHidingHelperTimeout(){this.hidingTimeoutId=setTimeout(()=>this.hide(),this.hidingTimeoutMS)}clearHidingHelperTimeout(){clearTimeout(this.hidingTimeoutId),this.hidingTimeoutId=0}insertTag(t,e,n,r=0){if(!this.sElem||!this.storedSelection)return;let i,s;i=this.outerTagSelection?e?this.outerTagSelection:new Ct(this.outerTagSelection.end,this.outerTagSelection.end):this.storedSelection,s=e?`<${t}>`+this.sElem.value.slice(i.start,i.end)+`</${t}>`:`<${t}>`,d(this.sElem,s,i.start,i.end),this.outerTagSelection=new Ct(i.start,i.start+s.length),this.storedSelection=new Ct(i.start+n+1,i.start+n+1+r),this.tagEndSelection=e?new Ct(i.end+t.length+n+4,i.end+t.length+n+4+r):this.storedSelection,this.selectStoredSelection()}backspaceOnTag(){if(!(this.sElem&&this.storedSelection&&this.tagEndSelection&&this.outerTagSelection))return;const t=this.tagEndSelection;this.tagEndSelection=this.tagEndSelection.insertBackspace(this.sElem);const e=this.tagEndSelection.start-t.end;t!==this.storedSelection?(this.outerTagSelection=this.outerTagSelection.offset(0,2*e),this.storedSelection=this.storedSelection.insertBackspace(this.sElem),this.tagEndSelection=this.tagEndSelection.offset(e)):this.outerTagSelection=this.outerTagSelection.offset(0,e)}insertCharOnTag(t){if(!(this.sElem&&this.storedSelection&&this.tagEndSelection&&this.outerTagSelection))return;const e=this.tagEndSelection;this.tagEndSelection=this.tagEndSelection.insertText(this.sElem,t);const n=this.tagEndSelection.start-e.end;e!==this.storedSelection?(this.outerTagSelection=this.outerTagSelection.offset(0,2*n),this.storedSelection=this.storedSelection.insertText(this.sElem,t),this.tagEndSelection=this.tagEndSelection.offset(n)):this.outerTagSelection=this.outerTagSelection.offset(0,n)}selectOuterTagEnd(){this.sElem&&this.outerTagSelection&&this.sElem.setSelectionRange(this.outerTagSelection.end,this.outerTagSelection.end)}$initTagHelper(){return M($(xt.a).appendTo(document.body),"span",t=>{if(t.preventDefault(),!this.sElem)return;let e,n,r;this.clearHidingHelperTimeout();let i=0;switch(t.currentTarget.className){case"TagF":e="f3",n=!0,r=1,i=1;break;case"TagB":e="b",n=!0,r=1;break;case"TagI":e="i",n=!0,r=1;break;case"TagS":e="s",n=!0,r=1;break;case"TagU":e="u",n=!0,r=1;break;case"TagBR":e="br",n=!1,r=3;break;case"TagDice":e="1d6",n=!1,r=0,i=1;break;default:throw new Error("not implemented")}this.insertTag(e,n,r,i),$(this.sElem).triggerHandler("keyup")}).on("mouseenter",t=>{this.clearHidingHelperTimeout()}).on("mouseleave",t=>{this.setHidingHelperTimeout()})}setCurrentSelection(t){this.sElem=t,this.storedSelection=Ct.build(t)}clearTagInsertedCondition(){this.tagEndSelection=null,this.outerTagSelection=null}selectStoredSelection(t=0,e=0){this.sElem&&this.storedSelection&&this.storedSelection.select(this.sElem,t,e)}}var Bt=n(12),It=n.n(Bt),_t=(n(24),function(t,e,n,r){return new(n||(n=Promise))((function(i,s){function o(t){try{l(r.next(t))}catch(t){s(t)}}function a(t){try{l(r.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}l((r=r.apply(t,e||[])).next())}))});const Ot={enablePreview:!0,enableFav:!0,enableTagHelper:!0,enableTagCompletion:!0,enableEZFormSub:!0,enableBRConverter:!0,enableMultipleSubDenier:!0};class Lt{constructor(){this.db=new rt({dbName:tt,tableName:Lt.TABLE_NAME,dbVersion:et,optionalParameters:{autoIncrement:!1,keyPath:"id"}}),this.db.open()}get DBPromise(){return new Promise((t,e)=>{this.db.DBPromise.then(()=>t(),t=>e(t))})}get DBIsOpen(){return this.db.DBIsOpen}get(){return this.db.get(Lt.DB_KEY)}put(t){return t.id=Lt.DB_KEY,this.db.put(t)}}Lt.TABLE_NAME="Settings",Lt.DB_KEY=0;class $t{constructor(){this.db=new Lt,this.$settingsButton=this.initSettingsButton(),this.$settingsForm=this.initSettingsForm()}static initSettings(){return Object.assign({},Ot)}enableDOMFunction(){return this.$settingsButton.insertAfter($(".BUTT3 > img").parent().parent("a").next("a").next("a")),this}showForm(){this.$settingsForm.prependTo(document.body)}hideForm(){this.$settingsForm.detach()}applyToForm(){this.settings||(this.settings=$t.initSettings()),this.$settingsForm.find("#EnablePreview").prop("checked",this.settings.enablePreview),this.$settingsForm.find("#EnableFav").prop("checked",this.settings.enableFav),this.$settingsForm.find("#EnableTagHelper").prop("checked",this.settings.enableTagHelper),this.$settingsForm.find("#EnableTagCompletion").prop("checked",this.settings.enableTagCompletion),this.$settingsForm.find("#EnableEZFormSub").prop("checked",this.settings.enableEZFormSub),this.$settingsForm.find("#EnableBRConverter").prop("checked",this.settings.enableBRConverter),this.$settingsForm.find("#EnableMultipleSubDenier").prop("checked",this.settings.enableMultipleSubDenier)}extractFromForm(){return this.settings?(this.settings.enablePreview=this.$settingsForm.find("#EnablePreview").prop("checked"),this.settings.enableFav=this.$settingsForm.find("#EnableFav").prop("checked"),this.settings.enableTagHelper=this.$settingsForm.find("#EnableTagHelper").prop("checked"),this.settings.enableTagCompletion=this.$settingsForm.find("#EnableTagCompletion").prop("checked"),this.settings.enableEZFormSub=this.$settingsForm.find("#EnableEZFormSub").prop("checked"),this.settings.enableBRConverter=this.$settingsForm.find("#EnableBRConverter").prop("checked"),this.settings.enableMultipleSubDenier=this.$settingsForm.find("#EnableMultipleSubDenier").prop("checked"),this.settings):$t.initSettings()}loadOrInit(){return _t(this,void 0,void 0,(function*(){yield this.db.DBPromise;const t=yield this.db.get();return this.settings=t||$t.initSettings(),this.settings}))}save(){return _t(this,void 0,void 0,(function*(){this.settings&&(yield this.db.DBPromise,yield this.db.put(this.settings))}))}initSettingsButton(){const t=$(`<span class="BUTT3 ${$t.CLASSNAME_SHOW_SETTINGS_BUTTON}">TalkUtil設定</span>`);return M(t,t=>_t(this,void 0,void 0,(function*(){this.$settingsForm.parent().length>0?this.hideForm():(this.settings||(yield this.loadOrInit()),yield this.loadOrInit(),this.applyToForm(),this.showForm())}))),t}initSettingsForm(){const t=$(It.a);return M(t,".SaveSettings",t=>_t(this,void 0,void 0,(function*(){this.extractFromForm(),yield this.save(),this.hideForm()}))),M(t,".CancelSetting",t=>_t(this,void 0,void 0,(function*(){this.hideForm()}))),t}}$t.CLASSNAME_SHOW_SETTINGS_BUTTON="ShowTalkUtilSettingsBtn",Mt=void 0,Rt=void 0,kt=void 0,Dt=function*(){if(!document.getElementById("CL1"))return;const t=new $t,e=yield t.loadOrInit();t.enableDOMFunction(),e.enableBRConverter&&(new p).enable(document.body,"textarea[name^='dt_mes']"),e.enableTagHelper&&(new Nt).enable(document.body,"textarea[name^='dt_mes']"),e.enableTagCompletion&&(new _).enable(document.body,"textarea[name^='dt_mes']"),e.enableEZFormSub&&(new O).enable(document.body,"textarea[name^='dt_mes']","発言する"),e.enableMultipleSubDenier&&(new L).enable(document.body,"form"),e.enablePreview&&new Z(200).enable(),e.enableFav&&(new yt).enable(document.body),(new J).enable(),new P(tt).enable(document.body,".PreviewHeader")},new(kt||(kt=Promise))((function(t,e){function n(t){try{i(Dt.next(t))}catch(t){e(t)}}function r(t){try{i(Dt.throw(t))}catch(t){e(t)}}function i(e){var i;e.done?t(e.value):(i=e.value,i instanceof kt?i:new kt((function(t){t(i)}))).then(n,r)}i((Dt=Dt.apply(Mt,Rt||[])).next())}));var Mt,Rt,kt,Dt}]);